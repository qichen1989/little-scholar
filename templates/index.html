<!doctype html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Â∞èÂ≠¶ËÄÖ Little Scholar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@300;400;500;700&family=Fredoka+One&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      :root {
        --red: #c0392b;
        --red-light: #e74c3c;
        --gold: #f0a500;
        --gold-light: #f7c948;
        --cream: #fff8f0;
        --ink: #2c1a0e;
        --ink-light: #5c3d2e;
        --jade: #2ecc9a;
        --jade-dark: #1a9970;
        --sky: #5bc8f5;
        --bg: #fff3e8;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Noto Sans SC", sans-serif;
        background: var(--bg);
        min-height: 100vh;
      }
      .app {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0 20px;
        border-bottom: 3px solid var(--red);
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .logo {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 2rem;
        color: var(--red);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .nav-tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .nav-tab {
        padding: 8px 14px;
        border-radius: 20px;
        border: 2px solid var(--red);
        background: transparent;
        color: var(--red);
        font-family: "Fredoka One", cursive;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .nav-tab:hover,
      .nav-tab.active {
        background: var(--red);
        color: white;
      }
      .count-badge {
        background: var(--gold);
        color: var(--ink);
        border-radius: 10px;
        padding: 1px 6px;
        font-size: 0.75rem;
        margin-left: 4px;
      }
      .upload-area {
        border: 3px dashed var(--gold);
        border-radius: 24px;
        padding: 60px 40px;
        text-align: center;
        background: rgba(240, 165, 0, 0.05);
        cursor: pointer;
        transition: all 0.3s;
      }
      .upload-area:hover,
      .upload-area.drag-over {
        background: rgba(240, 165, 0, 0.12);
        border-color: var(--red);
        transform: scale(1.01);
      }
      .upload-icon {
        font-size: 4rem;
        margin-bottom: 16px;
        display: block;
        animation: float 3s ease-in-out infinite;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }
      .upload-title {
        font-family: "Fredoka One", cursive;
        font-size: 1.6rem;
        color: var(--ink);
        margin-bottom: 8px;
      }
      .upload-sub {
        color: var(--ink-light);
        font-size: 0.95rem;
      }
      .welcome-banner {
        background: linear-gradient(135deg, #c0392b, #8b1a1a);
        border-radius: 20px;
        padding: 24px 28px;
        color: white;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 20px;
        position: relative;
        overflow: hidden;
      }
      .welcome-banner::before {
        content: "Á¶è";
        position: absolute;
        right: 20px;
        top: -10px;
        font-family: "Ma Shan Zheng", cursive;
        font-size: 8rem;
        opacity: 0.1;
        color: var(--gold);
        pointer-events: none;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 20px;
        border-radius: 20px;
        border: none;
        font-family: "Fredoka One", cursive;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .btn-red {
        background: var(--red);
        color: white;
      }
      .btn-gold {
        background: var(--gold);
        color: var(--ink);
      }
      .btn-jade {
        background: var(--jade);
        color: white;
      }
      .btn-outline {
        background: white;
        color: var(--red);
        border: 2px solid var(--red);
      }
      .btn-sm {
        padding: 6px 14px;
        font-size: 0.85rem;
      }
      .btn-xs {
        padding: 4px 10px;
        font-size: 0.78rem;
      }
      .loading-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 8px 30px rgba(192, 57, 43, 0.12);
      }
      .loading-chars {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin: 24px 0;
        flex-wrap: wrap;
      }
      .loading-char {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 2.5rem;
        color: var(--red);
        animation: bounce 1.2s ease-in-out infinite;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }
        50% {
          transform: translateY(-16px) rotate(5deg);
        }
      }
      .article-text {
        background: white;
        border-radius: 20px;
        padding: 28px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.07);
        line-height: 3.2;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: flex-start;
      }
      .char-block {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        border-radius: 8px;
        padding: 4px 3px 2px;
        transition: all 0.2s;
        min-width: 36px;
      }
      .char-block:hover {
        background: rgba(240, 165, 0, 0.15);
        transform: scale(1.08);
      }
      .char-block.unknown {
        background: rgba(192, 57, 43, 0.12);
        border: 2px solid var(--red);
      }
      .char-block.unknown .char-zh {
        color: var(--red);
      }
      .char-block.punct {
        cursor: default;
        min-width: auto;
        padding: 4px 1px;
      }
      .char-block.punct:hover {
        background: none;
        transform: none;
      }
      .char-pinyin {
        font-size: 0.72rem;
        color: var(--ink-light);
        min-height: 14px;
        line-height: 1;
        margin-bottom: 1px;
      }
      .char-zh {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 1.6rem;
        line-height: 1;
        color: var(--ink);
      }
      .unknown-dot {
        width: 6px;
        height: 6px;
        background: var(--red);
        border-radius: 50%;
        margin-top: 2px;
      }
      .reading-hint {
        background: var(--gold-light);
        border-radius: 12px;
        padding: 10px 16px;
        font-size: 0.88rem;
        color: var(--ink);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .char-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }
      .char-card {
        background: white;
        border-radius: 16px;
        padding: 16px 12px;
        text-align: center;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }
      .char-card:hover {
        border-color: var(--gold);
        transform: translateY(-3px);
      }
      .big-char {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 2.8rem;
        color: var(--ink);
        line-height: 1;
        margin-bottom: 6px;
      }
      .section-title {
        font-family: "Fredoka One", cursive;
        font-size: 1.3rem;
        color: var(--ink);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .quiz-card {
        background: white;
        border-radius: 28px;
        padding: 28px 32px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 16px;
        position: relative;
        overflow: hidden;
      }
      .quiz-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--red),
          var(--gold),
          var(--jade)
        );
      }
      .quiz-char {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 6rem;
        color: var(--ink);
        line-height: 1;
      }
      .quiz-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 16px;
      }
      .option-btn {
        padding: 14px 10px;
        border-radius: 16px;
        border: 2px solid #e8ddd5;
        background: white;
        font-family: "Noto Sans SC", sans-serif;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .option-btn:hover:not(:disabled) {
        border-color: var(--gold);
        background: rgba(240, 165, 0, 0.08);
      }
      .option-btn.correct {
        background: rgba(46, 204, 154, 0.15);
        border-color: var(--jade);
        color: var(--jade-dark);
      }
      .option-btn.wrong {
        background: rgba(231, 76, 60, 0.12);
        border-color: var(--red-light);
        color: var(--red);
      }
      .progress-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #e0d6cc;
        transition: all 0.3s;
      }
      .progress-dot.correct {
        background: var(--jade);
      }
      .progress-dot.wrong {
        background: var(--red-light);
      }
      .progress-dot.current {
        background: var(--gold);
        transform: scale(1.3);
      }
      .writing-canvas {
        border-radius: 16px;
        border: 3px solid var(--gold);
        cursor: crosshair;
        display: block;
        touch-action: none;
        background: white;
      }
      .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--ink);
        color: white;
        padding: 12px 24px;
        border-radius: 20px;
        font-family: "Fredoka One", cursive;
        font-size: 0.95rem;
        z-index: 9999;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        white-space: nowrap;
      }
      .toast.show {
        transform: translateX(-50%) translateY(0);
      }
      .char-tooltip {
        position: fixed;
        background: var(--ink);
        color: white;
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 0.85rem;
        pointer-events: none;
        z-index: 1000;
        max-width: 200px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        transform: translateX(-50%) translateY(-110%);
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--ink-light);
      }
      /* history */
      .history-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }
      .history-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        position: relative;
      }
      .history-card:hover {
        border-color: var(--gold);
        transform: translateY(-3px);
      }
      .history-thumb {
        width: 100%;
        height: 80px;
        object-fit: cover;
        background: #f0e8e0;
      }
      .history-info {
        padding: 8px 10px;
      }
      .history-preview {
        font-size: 0.78rem;
        color: var(--ink);
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }
      .history-date {
        font-size: 0.7rem;
        color: var(--ink-light);
        margin-top: 4px;
      }
      .history-del {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.4);
        color: white;
        border: none;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        cursor: pointer;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      /* TTS */
      .tts-bar {
        position: sticky;
        bottom: 16px;
        margin-top: 20px;
        background: white;
        border-radius: 20px;
        padding: 14px 20px;
        box-shadow: 0 4px 24px rgba(192, 57, 43, 0.15);
        border: 2px solid var(--gold-light);
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .tts-btn {
        background: var(--red);
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        font-size: 1.2rem;
        cursor: pointer;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.15s;
      }
      .tts-btn:hover {
        transform: scale(1.1);
      }
      .tts-progress {
        flex: 1;
        min-width: 120px;
      }
      .tts-progress-bar {
        height: 10px;
        background: #f0e8e0;
        border-radius: 5px;
        margin-bottom: 4px;
        cursor: pointer;
        position: relative;
      }
      .tts-progress-bar:hover {
        background: #e8ddd5;
      }
      .tts-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--red), var(--gold));
        border-radius: 5px;
        transition: width 0.2s;
        pointer-events: none;
        position: relative;
      }
      .tts-progress-fill::after {
        content: "";
        position: absolute;
        right: -6px;
        top: 50%;
        transform: translateY(-50%);
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--red);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
      }
      .tts-label {
        font-size: 0.72rem;
        color: var(--ink-light);
        font-family: "Fredoka One", cursive;
        display: flex;
        justify-content: space-between;
      }
      .char-block.speaking {
        background: rgba(240, 165, 0, 0.3);
        border-radius: 6px;
        transform: scale(1.15);
      }
      /* Login */
      .login-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          #8b1a1a 0%,
          #c0392b 50%,
          #f0a500 100%
        );
        padding: 20px;
      }
      .login-card {
        background: white;
        border-radius: 28px;
        padding: 40px 36px;
        width: 100%;
        max-width: 380px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      .login-logo {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 3rem;
        color: var(--red);
        margin-bottom: 4px;
      }
      .login-input {
        width: 100%;
        padding: 14px 16px;
        border-radius: 14px;
        border: 2px solid #e8ddd5;
        font-size: 1.1rem;
        outline: none;
        font-family: "Noto Sans SC", sans-serif;
        transition: border-color 0.2s;
        margin-bottom: 20px;
        letter-spacing: 0.1em;
      }
      .login-input:focus {
        border-color: var(--red);
      }
      .login-btn {
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: none;
        background: linear-gradient(135deg, var(--red), #922b21);
        color: white;
        font-family: "Fredoka One", cursive;
        font-size: 1.1rem;
        cursor: pointer;
        transition:
          opacity 0.2s,
          transform 0.2s;
      }
      .login-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .login-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      @media (max-width: 500px) {
        .char-zh {
          font-size: 1.3rem;
        }
        .quiz-char {
          font-size: 4rem;
        }
        .nav-tab {
          padding: 6px 10px;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useRef, useCallback, useEffect } = React;

      const shuffle = (a) => [...a].sort(() => Math.random() - 0.5);
      const isChinese = (ch) => /[\u4e00-\u9fff\u3400-\u4dbf]/.test(ch);
      const isPunct = (ch) =>
        /[\uff0c\u3002\uff01\uff1f\u3001\uff1b\uff1a\u201c\u201d\u2018\u2019\u300c\u300d\u3010\u3011\uff08\uff09\u2026\u2014\u00b7.,!?;:()\\/\[\]]/.test(
          ch,
        );

      // ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const apiFetch = async (url, opts = {}) => {
        const res = await fetch(url, {
          credentials: "include",
          ...opts,
          headers: {
            "Content-Type": "application/json",
            ...(opts.headers || {}),
          },
        });
        if (res.status === 401) throw new Error("SESSION_EXPIRED");
        return res;
      };
      const apiJson = async (url, opts = {}) => {
        const r = await apiFetch(url, opts);
        return r.json();
      };

      const apiLogin = (pw) =>
        apiFetch("/api/login", {
          method: "POST",
          body: JSON.stringify({ password: pw }),
        }).then((r) => {
          if (!r.ok) throw new Error("wrong");
        });
      const apiLogout = () => apiFetch("/api/logout", { method: "POST" });
      const apiCheckAuth = () =>
        apiJson("/api/me").then((d) => d.authenticated);
      const apiLoad = () => apiJson("/api/data");
      const apiSave = (d) =>
        apiFetch("/api/data", { method: "POST", body: JSON.stringify(d) });
      const apiLookup = (chars) =>
        apiJson("/api/lookup", {
          method: "POST",
          body: JSON.stringify({ characters: chars }),
        }).then((d) => d.lookup || {});
      const apiOcr = (b64) =>
        apiJson("/api/ocr", {
          method: "POST",
          body: JSON.stringify({ image_base64: b64 }),
        }).then((d) => {
          if (d.error) throw new Error(d.error);
          return d.text;
        });

      // ‚îÄ‚îÄ Image helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function preprocessImage(dataUrl) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onerror = () => reject(new Error("Could not load image"));
          img.onload = () => {
            try {
              const MAX = 1000;
              let w = img.width,
                h = img.height;
              if (Math.max(w, h) > MAX) {
                const s = MAX / Math.max(w, h);
                w = Math.round(w * s);
                h = Math.round(h * s);
              }
              const canvas = document.createElement("canvas");
              canvas.width = w;
              canvas.height = h;
              const ctx = canvas.getContext("2d");
              ctx.imageSmoothingEnabled = true;
              ctx.imageSmoothingQuality = "high";
              ctx.drawImage(img, 0, 0, w, h);
              resolve(canvas.toDataURL("image/jpeg", 0.7).split(",")[1]);
            } catch (e) {
              reject(e);
            }
          };
          img.src = dataUrl;
        });
      }
      function makeThumbnail(dataUrl) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const MAX = 120,
              s = Math.min(1, MAX / Math.max(img.width, img.height));
            const c = document.createElement("canvas");
            c.width = Math.round(img.width * s);
            c.height = Math.round(img.height * s);
            c.getContext("2d").drawImage(img, 0, 0, c.width, c.height);
            resolve(c.toDataURL("image/jpeg", 0.6));
          };
          img.onerror = () => resolve(null);
          img.src = dataUrl;
        });
      }

      // ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function LoginScreen({ onLogin }) {
        const [pw, setPw] = useState("");
        const [err, setErr] = useState("");
        const [busy, setBusy] = useState(false);
        const submit = async (e) => {
          e.preventDefault();
          if (!pw) return;
          setBusy(true);
          setErr("");
          try {
            await apiLogin(pw);
            onLogin();
          } catch {
            setErr("Wrong password ‚Äî try again! üîí");
          } finally {
            setBusy(false);
          }
        };
        return (
          <div className="login-screen">
            <div className="login-card">
              <div style={{ fontSize: "4rem", marginBottom: 8 }}>üèÆ</div>
              <div className="login-logo">Â∞èÂ≠¶ËÄÖ</div>
              <div
                style={{
                  fontFamily: "'Fredoka One',cursive",
                  fontSize: "1rem",
                  color: "var(--ink-light)",
                  marginBottom: 32,
                }}
              >
                Little Scholar ‚Äî Chinese Reading App
              </div>
              <form onSubmit={submit}>
                <label
                  style={{
                    display: "block",
                    textAlign: "left",
                    fontFamily: "'Fredoka One',cursive",
                    fontSize: "0.85rem",
                    color: "var(--ink-light)",
                    marginBottom: 6,
                  }}
                >
                  Password
                </label>
                <input
                  className="login-input"
                  type="password"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  value={pw}
                  onChange={(e) => setPw(e.target.value)}
                  autoFocus
                />
                <button className="login-btn" type="submit" disabled={busy}>
                  {busy ? "Checking‚Ä¶" : "Enter üèÆ"}
                </button>
              </form>
              {err && (
                <div
                  style={{
                    color: "var(--red)",
                    fontSize: "0.85rem",
                    marginTop: 12,
                    fontFamily: "'Fredoka One',cursive",
                  }}
                >
                  {err}
                </div>
              )}
            </div>
          </div>
        );
      }

      function Root() {
        const [authed, setAuthed] = useState(null);
        useEffect(() => {
          apiCheckAuth()
            .then((ok) => setAuthed(ok))
            .catch(() => setAuthed(false));
        }, []);
        if (authed === null)
          return (
            <div
              style={{
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                height: "100vh",
                fontSize: "3rem",
              }}
            >
              üèÆ
            </div>
          );
        if (!authed) return <LoginScreen onLogin={() => setAuthed(true)} />;
        return <App onLogout={() => setAuthed(false)} />;
      }

      // ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function App({ onLogout }) {
        const [screen, setScreen] = useState("home");
        const [parsedArticle, setParsedArticle] = useState(null);
        const [loading, setLoading] = useState(false);
        const [loadingMsg, setLoadingMsg] = useState("");
        const [unknownChars, setUnknownChars] = useState({});
        const [masteredChars, setMasteredChars] = useState({});
        const [masteredCharData, setMasteredCharData] = useState({});
        const [articleHistory, setArticleHistory] = useState([]);
        const [quizState, setQuizState] = useState(null);
        const [toast, setToast] = useState({ msg: "", show: false });
        const [tooltip, setTooltip] = useState({
          visible: false,
          char: null,
          x: 0,
          y: 0,
        });
        const [dataReady, setDataReady] = useState(false);

        const fileRef = useRef();
        const canvasRef = useRef();
        const isDrawing = useRef(false);
        const lastPos = useRef(null);
        const saveTimer = useRef(null);

        // TTS
        const [tts, setTts] = useState({
          playing: false,
          sentenceIdx: -1,
          rate: 0.8,
          voiceURI: "",
        });
        const [voices, setVoices] = useState([]);
        const ttsToken = useRef(0);
        const sentencesCache = useRef([]);
        const sentenceMap = useRef({});
        const SENT_ENDS = /[„ÄÇÔºÅÔºü‚Ä¶]/;
        const BAD_VOICE = /cantonese|yue|zh[-_]hk/i;
        const GOOD_VOICE = /mandarin|putonghua|ÊôÆÈÄöËØù|ÂõΩËØ≠/i;

        const showToast = (msg) => {
          setToast({ msg, show: true });
          setTimeout(() => setToast((t) => ({ ...t, show: false })), 2200);
        };
        const unknownCount = Object.keys(unknownChars).length;

        // ‚îÄ‚îÄ Load from server ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        useEffect(() => {
          apiLoad()
            .then((d) => {
              if (d.unknownChars) setUnknownChars(d.unknownChars);
              if (d.masteredChars) setMasteredChars(d.masteredChars);
              if (d.masteredCharData) setMasteredCharData(d.masteredCharData);
              if (d.articleHistory) setArticleHistory(d.articleHistory);
            })
            .catch((e) => {
              if (e.message === "SESSION_EXPIRED") onLogout();
            })
            .finally(() => setDataReady(true));
        }, []);

        // ‚îÄ‚îÄ Auto-save (debounced) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        useEffect(() => {
          if (!dataReady) return;
          if (saveTimer.current) clearTimeout(saveTimer.current);
          saveTimer.current = setTimeout(() => {
            apiSave({
              unknownChars,
              masteredChars,
              masteredCharData,
              articleHistory,
            }).catch((e) => {
              if (e.message === "SESSION_EXPIRED") onLogout();
            });
          }, 1500);
        }, [
          unknownChars,
          masteredChars,
          masteredCharData,
          articleHistory,
          dataReady,
        ]);

        // ‚îÄ‚îÄ File handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const handleFile = async (file) => {
          if (!file) return;
          setLoading(true);
          try {
            const dataUrl = await new Promise((res, rej) => {
              const r = new FileReader();
              r.onload = (e) => res(e.target.result);
              r.onerror = () => rej(new Error("Read failed"));
              r.readAsDataURL(file);
            });
            setLoadingMsg("Enhancing image‚Ä¶ ‚ú®");
            const base64 = await preprocessImage(dataUrl);
            setLoadingMsg("Reading with Google Vision‚Ä¶ üìñ");
            const text = await apiOcr(base64);
            const unique = [...new Set(text.split("").filter(isChinese))];
            const lookup = {};
            for (let i = 0; i < unique.length; i += 50) {
              setLoadingMsg(
                `Looking up pinyin‚Ä¶ ${Math.min(i + 50, unique.length)}/${unique.length} üîç`,
              );
              Object.assign(lookup, await apiLookup(unique.slice(i, i + 50)));
            }
            const arr = [];
            for (const ch of text) {
              if (ch === "\n") arr.push({ char: "\n", type: "break" });
              else if (" \t\r".includes(ch)) continue;
              else if (isPunct(ch)) arr.push({ char: ch, type: "punct" });
              else if (isChinese(ch)) {
                const info = lookup[ch] || {};
                arr.push({
                  char: ch,
                  pinyin: info.pinyin || "?",
                  meaning: info.meaning || "",
                });
              } else arr.push({ char: ch, type: "latin" });
            }
            setParsedArticle(arr);
            const thumb = await makeThumbnail(dataUrl);
            const preview = text
              .replace(/[\s\n]+/g, " ")
              .trim()
              .slice(0, 60);
            const entry = {
              id: Date.now(),
              date: new Date().toLocaleDateString(),
              preview,
              thumb,
              arr,
            };
            setArticleHistory((prev) =>
              [entry, ...prev.filter((h) => h.id !== entry.id)].slice(0, 10),
            );
            setScreen("reading");
          } catch (e) {
            if (e.message === "SESSION_EXPIRED") {
              onLogout();
              return;
            }
            showToast("‚ö†Ô∏è " + (e.message || "Something went wrong"));
          } finally {
            setLoading(false);
          }
        };

        const onDrop = useCallback((e) => {
          e.preventDefault();
          const f = e.dataTransfer.files[0];
          if (f?.type.startsWith("image/")) handleFile(f);
        }, []);

        // ‚îÄ‚îÄ Char management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const toggleUnknown = (item) => {
          if (
            !item.char ||
            item.type === "punct" ||
            item.type === "break" ||
            item.type === "latin"
          )
            return;
          setUnknownChars((prev) => {
            const next = { ...prev };
            if (next[item.char]) {
              delete next[item.char];
              showToast(`‚úÖ Removed "${item.char}"`);
            } else {
              next[item.char] = {
                char: item.char,
                pinyin: item.pinyin,
                meaning: item.meaning,
              };
              showToast(`üìå Added "${item.char}"`);
            }
            return next;
          });
        };

        const markMastered = (key) => {
          const info = unknownChars[key] || {};
          setMasteredChars((prev) => ({ ...prev, [key]: true }));
          setMasteredCharData((prev) => ({ ...prev, [key]: info }));
          setUnknownChars((prev) => {
            const n = { ...prev };
            delete n[key];
            return n;
          });
          showToast(
            `üåü "${key}" mastered ‚Äî will appear occasionally in quizzes!`,
          );
        };

        const removeChar = (key) => {
          setUnknownChars((prev) => {
            const n = { ...prev };
            delete n[key];
            return n;
          });
          setMasteredChars((prev) => {
            const n = { ...prev };
            delete n[key];
            return n;
          });
          setMasteredCharData((prev) => {
            const n = { ...prev };
            delete n[key];
            return n;
          });
        };

        // ‚îÄ‚îÄ Quiz ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const REVIEW_RATE = 0.25;

        const buildQuestionList = () => {
          const active = shuffle(Object.values(unknownChars));
          const mastered = shuffle(
            Object.keys(masteredChars).map((k) => ({
              char: k,
              ...(masteredCharData[k] || { pinyin: "?", meaning: "" }),
              isReview: true,
            })),
          );
          if (mastered.length === 0)
            return active.map((c) => ({ ...c, isReview: false }));
          const result = [];
          let mi = 0;
          for (let i = 0; i < active.length; i++) {
            result.push({ ...active[i], isReview: false });
            if (
              (i + 1) % Math.round(1 / REVIEW_RATE) === 0 &&
              mi < mastered.length
            )
              result.push({ ...mastered[mi++] });
          }
          return result;
        };

        const buildOptions = (correct, pool) =>
          shuffle([
            correct,
            ...shuffle(pool.filter((c) => c.char !== correct.char)).slice(0, 3),
          ]);

        const startQuiz = (type) => {
          if (unknownCount < 2) {
            showToast("Add at least 2 characters first!");
            return;
          }
          const pool = [
            ...Object.values(unknownChars),
            ...Object.keys(masteredChars).map((k) => ({
              char: k,
              ...(masteredCharData[k] || {}),
            })),
          ];
          const questions = buildQuestionList();
          setQuizState({
            type,
            questions,
            current: 0,
            answers: [],
            options: buildOptions(questions[0], pool),
            revealed: false,
            selectedOption: null,
            done: false,
            pool,
          });
        };

        const advanceQuiz = (newAnswers, isCorrect) => {
          const { questions, current, type, pool } = quizState;
          const next = current + 1;
          if (next >= questions.length) {
            setQuizState((p) => ({ ...p, answers: newAnswers, done: true }));
            return;
          }
          setQuizState((p) => ({
            ...p,
            answers: newAnswers,
            current: next,
            options: buildOptions(questions[next], pool),
            revealed: false,
            selectedOption:
              isCorrect !== undefined
                ? isCorrect
                  ? "correct"
                  : "wrong"
                : null,
          }));
          if (isCorrect !== undefined)
            setTimeout(
              () =>
                setQuizState((p) => (p ? { ...p, selectedOption: null } : p)),
              700,
            );
        };

        const handleAnswer = (chosen) => {
          const { questions, current, type, answers } = quizState;
          const correct = questions[current];
          const isCorrect =
            type === "pinyin"
              ? chosen.pinyin === correct.pinyin
              : chosen.meaning === correct.meaning;
          advanceQuiz(
            [
              ...answers,
              {
                correct: isCorrect,
                char: correct.char,
                isReview: correct.isReview,
              },
            ],
            isCorrect,
          );
        };

        const handleFlashcard = (knew) => {
          const { questions, current, answers } = quizState;
          const item = questions[current];
          clearCanvas();
          advanceQuiz(
            [
              ...answers,
              { correct: knew, char: item.char, isReview: item.isReview },
            ],
            undefined,
          );
        };

        // ‚îÄ‚îÄ Canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const getPos = (e, c) => {
          const r = c.getBoundingClientRect(),
            s = e.touches ? e.touches[0] : e;
          return {
            x: (s.clientX - r.left) * (c.width / r.width),
            y: (s.clientY - r.top) * (c.height / r.height),
          };
        };
        const startDraw = (e) => {
          e.preventDefault();
          const c = canvasRef.current;
          if (!c) return;
          isDrawing.current = true;
          const p = getPos(e, c);
          lastPos.current = p;
          const ctx = c.getContext("2d");
          ctx.beginPath();
          ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
          ctx.fillStyle = "#2C1A0E";
          ctx.fill();
        };
        const draw = (e) => {
          e.preventDefault();
          if (!isDrawing.current) return;
          const c = canvasRef.current;
          if (!c) return;
          const ctx = c.getContext("2d");
          const p = getPos(e, c);
          ctx.beginPath();
          ctx.moveTo(lastPos.current.x, lastPos.current.y);
          ctx.lineTo(p.x, p.y);
          ctx.strokeStyle = "#2C1A0E";
          ctx.lineWidth = 5;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.stroke();
          lastPos.current = p;
        };
        const endDraw = (e) => {
          e.preventDefault();
          isDrawing.current = false;
          lastPos.current = null;
        };
        const clearCanvas = () => {
          const c = canvasRef.current;
          if (c) c.getContext("2d").clearRect(0, 0, c.width, c.height);
        };

        const handleCharHover = (e, item) => {
          if (!item.pinyin) return;
          const r = e.currentTarget.getBoundingClientRect();
          setTooltip({
            visible: true,
            char: item,
            x: r.left + r.width / 2,
            y: r.top + window.scrollY,
          });
        };

        // ‚îÄ‚îÄ TTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const loadVoices = useCallback(() => {
          const all = window.speechSynthesis.getVoices();
          const zh = all.filter(
            (v) =>
              v.lang.startsWith("zh") &&
              !BAD_VOICE.test(v.name) &&
              !BAD_VOICE.test(v.lang),
          );
          if (!zh.length) return;
          setVoices(zh);
          setTts((t) => {
            if (t.voiceURI) return t;
            const best =
              zh.find((v) => GOOD_VOICE.test(v.name)) ||
              zh.find((v) => v.lang === "zh-CN") ||
              zh[0];
            return { ...t, voiceURI: best.voiceURI };
          });
        }, []);
        useEffect(() => {
          loadVoices();
          window.speechSynthesis.onvoiceschanged = loadVoices;
          return () => {
            window.speechSynthesis.onvoiceschanged = null;
          };
        }, [loadVoices]);

        const ttsStop = useCallback(() => {
          ttsToken.current += 1;
          window.speechSynthesis.cancel();
          setTimeout(() => window.speechSynthesis.cancel(), 50);
          setTts((t) => ({ ...t, playing: false, sentenceIdx: -1 }));
        }, []);

        const buildSentences = (art) => {
          const sents = [];
          let cur = { text: "", si: 0 },
            si = 0;
          art.forEach((item) => {
            if (!item.char || item.type === "break") return;
            if (item.type === "punct") {
              cur.text += item.char;
              if (SENT_ENDS.test(item.char) && cur.text.trim()) {
                sents.push({ ...cur });
                cur = { text: "", si: ++si };
              }
            } else if (!item.type) cur.text += item.char;
          });
          if (cur.text.trim()) sents.push(cur);
          return sents;
        };

        const doSpeak = useCallback(
          (startPos = 0) => {
            if (!parsedArticle) return;
            ttsToken.current += 1;
            const myToken = ttsToken.current;
            window.speechSynthesis.cancel();
            const sents = sentencesCache.current;
            if (!sents.length) return;
            const voice =
              window.speechSynthesis
                .getVoices()
                .find((v) => v.voiceURI === tts.voiceURI) || null;
            let pos = startPos;
            setTts((t) => ({
              ...t,
              playing: true,
              sentenceIdx: sents[startPos]?.si ?? 0,
            }));
            const next = () => {
              if (ttsToken.current !== myToken) return;
              if (pos >= sents.length) {
                setTts((t) => ({ ...t, playing: false, sentenceIdx: -1 }));
                return;
              }
              const s = sents[pos];
              setTts((t) => ({ ...t, sentenceIdx: s.si }));
              const utt = new SpeechSynthesisUtterance(s.text);
              utt.lang = "zh-CN";
              utt.rate = tts.rate;
              if (voice) utt.voice = voice;
              utt.onend = () => {
                if (ttsToken.current !== myToken) return;
                pos++;
                next();
              };
              utt.onerror = (e) => {
                if (e.error === "interrupted" || e.error === "canceled") return;
                if (ttsToken.current !== myToken) return;
                pos++;
                next();
              };
              window.speechSynthesis.speak(utt);
            };
            next();
          },
          [parsedArticle, tts.rate, tts.voiceURI],
        );

        const ttsSpeak = useCallback(() => doSpeak(0), [doSpeak]);

        const ttsSeek = useCallback(
          (e) => {
            if (!parsedArticle) return;
            const bar = e.currentTarget,
              rect = bar.getBoundingClientRect();
            const pct = Math.max(
              0,
              Math.min(
                1,
                ((e.clientX || e.touches?.[0]?.clientX || rect.left) -
                  rect.left) /
                  rect.width,
              ),
            );
            const sents = sentencesCache.current;
            if (!sents.length) return;
            const targetPos = Math.floor(pct * sents.length);
            ttsToken.current += 1;
            window.speechSynthesis.cancel();
            const myToken = ttsToken.current;
            const voice =
              window.speechSynthesis
                .getVoices()
                .find((v) => v.voiceURI === tts.voiceURI) || null;
            let pos = targetPos;
            setTts((t) => ({
              ...t,
              playing: true,
              sentenceIdx: sents[targetPos]?.si ?? 0,
            }));
            const next = () => {
              if (ttsToken.current !== myToken) return;
              if (pos >= sents.length) {
                setTts((t) => ({ ...t, playing: false, sentenceIdx: -1 }));
                return;
              }
              const s = sents[pos];
              setTts((t) => ({ ...t, sentenceIdx: s.si }));
              const utt = new SpeechSynthesisUtterance(s.text);
              utt.lang = "zh-CN";
              utt.rate = tts.rate;
              if (voice) utt.voice = voice;
              utt.onend = () => {
                if (ttsToken.current !== myToken) return;
                pos++;
                next();
              };
              utt.onerror = (e) => {
                if (e.error === "interrupted" || e.error === "canceled") return;
                if (ttsToken.current !== myToken) return;
                pos++;
                next();
              };
              window.speechSynthesis.speak(utt);
            };
            setTimeout(next, 150);
          },
          [parsedArticle, tts.rate, tts.voiceURI],
        );

        useEffect(() => {
          if (!parsedArticle) return;
          sentencesCache.current = buildSentences(parsedArticle);
          const map = {};
          let si = 0;
          parsedArticle.forEach((item, i) => {
            if (!item.type && item.char) map[i] = si;
            if (item.type === "punct" && SENT_ENDS.test(item.char)) si++;
          });
          sentenceMap.current = map;
        }, [parsedArticle]);
        useEffect(() => {
          return () => {
            ttsToken.current += 1;
            window.speechSynthesis.cancel();
          };
        }, [parsedArticle]);

        // ‚îÄ‚îÄ Screens ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const renderHome = () => (
          <div>
            <div className="welcome-banner">
              <span style={{ fontSize: "3rem" }}>üéã</span>
              <div>
                <div
                  style={{
                    fontFamily: "'Fredoka One',cursive",
                    fontSize: "1.5rem",
                    marginBottom: 4,
                  }}
                >
                  Hello, Little Scholar! ‰Ω†Â•Ω!
                </div>
                <div style={{ opacity: 0.9, fontSize: "0.95rem" }}>
                  Upload a photo of your Chinese article to start reading &amp;
                  learning!
                </div>
              </div>
              <div
                style={{ marginLeft: "auto", fontSize: "1.5rem", opacity: 0.7 }}
              >
                üèÆüèÆ
              </div>
            </div>
            <input
              ref={fileRef}
              type="file"
              accept="image/*"
              capture="environment"
              style={{ display: "none" }}
              onChange={(e) => handleFile(e.target.files[0])}
            />
            <div
              className="upload-area"
              onDrop={onDrop}
              onDragOver={(e) => e.preventDefault()}
              onClick={() => fileRef.current?.click()}
            >
              <span className="upload-icon">üì∏</span>
              <div className="upload-title">
                Take a Photo or Upload an Image
              </div>
              <div className="upload-sub">
                Drop your Chinese article here, or click to choose a file
              </div>
            </div>
            {unknownCount > 0 && (
              <div style={{ marginTop: 24, textAlign: "center" }}>
                <p
                  style={{
                    color: "var(--ink-light)",
                    marginBottom: 12,
                    fontFamily: "'Fredoka One',cursive",
                  }}
                >
                  You have {unknownCount} character{unknownCount > 1 ? "s" : ""}{" "}
                  in your study list üìö
                </p>
                <button
                  className="btn btn-jade"
                  onClick={() => setScreen("chars")}
                >
                  üìã Review My Characters
                </button>
              </div>
            )}
            {articleHistory.length > 0 && (
              <div style={{ marginTop: 28 }}>
                <div
                  style={{
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "space-between",
                    marginBottom: 12,
                  }}
                >
                  <div className="section-title">
                    üïê Recent Articles ({articleHistory.length}/10)
                  </div>
                  <button
                    className="btn btn-outline btn-xs"
                    onClick={() => {
                      if (confirm("Clear all history?")) setArticleHistory([]);
                    }}
                  >
                    Clear all
                  </button>
                </div>
                <div className="history-grid">
                  {articleHistory.map((entry) => (
                    <div
                      key={entry.id}
                      className="history-card"
                      onClick={() => {
                        setParsedArticle(entry.arr);
                        setScreen("reading");
                      }}
                    >
                      {entry.thumb ? (
                        <img
                          src={entry.thumb}
                          alt=""
                          className="history-thumb"
                        />
                      ) : (
                        <div
                          className="history-thumb"
                          style={{
                            display: "flex",
                            alignItems: "center",
                            justifyContent: "center",
                            fontSize: "2rem",
                          }}
                        >
                          üìÑ
                        </div>
                      )}
                      <button
                        className="history-del"
                        onClick={(e) => {
                          e.stopPropagation();
                          setArticleHistory((prev) =>
                            prev.filter((h) => h.id !== entry.id),
                          );
                        }}
                      >
                        ‚úï
                      </button>
                      <div className="history-info">
                        <div className="history-preview">{entry.preview}</div>
                        <div className="history-date">{entry.date}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );

        const renderReading = () => {
          if (!parsedArticle) return null;
          const totalSents = Math.max(1, sentencesCache.current.length || 1);
          const pct =
            tts.sentenceIdx >= 0
              ? Math.round(((tts.sentenceIdx + 1) / totalSents) * 100)
              : 0;
          return (
            <div>
              <div
                style={{
                  display: "flex",
                  gap: 10,
                  marginBottom: 16,
                  flexWrap: "wrap",
                  alignItems: "center",
                }}
              >
                <button
                  className="btn btn-outline btn-sm"
                  onClick={() => {
                    ttsStop();
                    setScreen("home");
                  }}
                >
                  ‚Üê Back
                </button>
                <div className="reading-hint" style={{ margin: 0, flex: 1 }}>
                  üí° Tap any character to add/remove from study list
                </div>
              </div>
              <div className="article-text">
                {parsedArticle.map((item, idx) => {
                  if (item.type === "break")
                    return (
                      <div key={idx} style={{ width: "100%", height: 8 }} />
                    );
                  if (item.type === "punct" || item.type === "latin")
                    return (
                      <span key={idx} className="char-block punct">
                        <span className="char-pinyin" />
                        <span
                          className="char-zh"
                          style={{ fontSize: "1.4rem" }}
                        >
                          {item.char}
                        </span>
                      </span>
                    );
                  const isUnknown = !!unknownChars[item.char];
                  const isSpeaking =
                    tts.playing && sentenceMap.current[idx] === tts.sentenceIdx;
                  return (
                    <span
                      key={idx}
                      className={`char-block${isUnknown ? " unknown" : ""}${isSpeaking ? " speaking" : ""}`}
                      onClick={() => toggleUnknown(item)}
                      onMouseEnter={(e) => handleCharHover(e, item)}
                      onMouseLeave={() =>
                        setTooltip((t) => ({ ...t, visible: false }))
                      }
                    >
                      <span className="char-pinyin">{item.pinyin || ""}</span>
                      <span className="char-zh">{item.char}</span>
                      {isUnknown && <span className="unknown-dot" />}
                    </span>
                  );
                })}
              </div>
              {unknownCount > 0 && (
                <div style={{ marginTop: 20, textAlign: "center" }}>
                  <button
                    className="btn btn-jade"
                    onClick={() => setScreen("chars")}
                  >
                    üìã Review {unknownCount} Saved Character
                    {unknownCount > 1 ? "s" : ""}
                  </button>
                </div>
              )}
              {/* TTS bar */}
              <div className="tts-bar">
                <button
                  className="tts-btn"
                  onClick={() => (tts.playing ? ttsStop() : ttsSpeak())}
                >
                  {tts.playing ? "‚èπ" : "‚ñ∂Ô∏è"}
                </button>
                <div className="tts-progress">
                  <div
                    className="tts-progress-bar"
                    onClick={ttsSeek}
                    onTouchStart={ttsSeek}
                  >
                    <div
                      className="tts-progress-fill"
                      style={{ width: `${pct}%` }}
                    />
                  </div>
                  <div className="tts-label">
                    <span>
                      {tts.playing ? "üîä Reading‚Ä¶" : "‚ñ∂ Tap to read aloud"}
                    </span>
                    {tts.sentenceIdx >= 0 && (
                      <span style={{ color: "var(--red)", fontWeight: 600 }}>
                        {pct}%
                      </span>
                    )}
                  </div>
                </div>
                <div
                  style={{
                    display: "flex",
                    alignItems: "center",
                    gap: 6,
                    flexWrap: "wrap",
                  }}
                >
                  {voices.length > 1 && (
                    <select
                      value={tts.voiceURI}
                      onChange={(e) => {
                        ttsStop();
                        setTts((t) => ({ ...t, voiceURI: e.target.value }));
                      }}
                      style={{
                        border: "2px solid #e8ddd5",
                        borderRadius: 8,
                        padding: "4px 8px",
                        fontFamily: "'Fredoka One',cursive",
                        fontSize: "0.78rem",
                        background: "white",
                        cursor: "pointer",
                        maxWidth: 140,
                      }}
                    >
                      {voices.map((v) => (
                        <option key={v.voiceURI} value={v.voiceURI}>
                          {v.name
                            .replace(/Microsoft |Google |Apple /g, "")
                            .slice(0, 22)}
                        </option>
                      ))}
                    </select>
                  )}
                  <select
                    value={tts.rate}
                    onChange={(e) => {
                      ttsStop();
                      setTts((t) => ({
                        ...t,
                        rate: parseFloat(e.target.value),
                      }));
                    }}
                  >
                    <option value={0.5}>üê¢ Slow</option>
                    <option value={0.8}>üö∂ Normal</option>
                    <option value={1.0}>üèÉ Fast</option>
                  </select>
                </div>
              </div>
            </div>
          );
        };

        const renderChars = () => {
          const chars = Object.values(unknownChars);
          const mastered = Object.keys(masteredChars);
          return (
            <div>
              <div
                style={{
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "space-between",
                  marginBottom: 16,
                  flexWrap: "wrap",
                  gap: 8,
                }}
              >
                <div className="section-title">üìö My Study List</div>
                {chars.length > 0 && (
                  <button
                    className="btn btn-red btn-sm"
                    onClick={() => setScreen("quiz")}
                  >
                    üéÆ Start Quiz
                  </button>
                )}
              </div>
              {chars.length === 0 ? (
                <div className="empty-state">
                  <span
                    style={{
                      fontSize: "4rem",
                      display: "block",
                      marginBottom: 16,
                    }}
                  >
                    üì≠
                  </span>
                  <h3
                    style={{
                      fontFamily: "'Fredoka One',cursive",
                      fontSize: "1.4rem",
                      color: "var(--ink)",
                      marginBottom: 8,
                    }}
                  >
                    No characters yet!
                  </h3>
                  <p>Read an article and tap characters you don't know.</p>
                  <button
                    className="btn btn-gold"
                    style={{ marginTop: 20 }}
                    onClick={() => setScreen("home")}
                  >
                    üì∏ Upload an Article
                  </button>
                </div>
              ) : (
                <>
                  <p
                    style={{
                      color: "var(--ink-light)",
                      marginBottom: 16,
                      fontSize: "0.9rem",
                    }}
                  >
                    Tap a card to mark as mastered ‚≠ê ‚Ä¢ {mastered.length}{" "}
                    mastered so far!
                  </p>
                  <div className="char-grid">
                    {chars.map((item) => (
                      <div
                        key={item.char}
                        className="char-card"
                        onClick={() => markMastered(item.char)}
                      >
                        <button
                          style={{
                            position: "absolute",
                            top: 6,
                            right: 8,
                            background: "none",
                            border: "none",
                            color: "#ccc",
                            cursor: "pointer",
                            fontSize: "1rem",
                          }}
                          onClick={(e) => {
                            e.stopPropagation();
                            removeChar(item.char);
                          }}
                        >
                          √ó
                        </button>
                        <div className="big-char">{item.char}</div>
                        <div
                          style={{
                            fontSize: "0.85rem",
                            color: "var(--ink-light)",
                            marginBottom: 4,
                          }}
                        >
                          {item.pinyin}
                        </div>
                        <div style={{ fontSize: "0.78rem", color: "#888" }}>
                          {item.meaning}
                        </div>
                      </div>
                    ))}
                  </div>
                </>
              )}
              {mastered.length > 0 && (
                <div style={{ marginTop: 28 }}>
                  <div
                    style={{
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "space-between",
                      marginBottom: 8,
                    }}
                  >
                    <div className="section-title">
                      ‚≠ê Mastered ({mastered.length})
                    </div>
                  </div>
                  <p
                    style={{
                      color: "var(--ink-light)",
                      marginBottom: 12,
                      fontSize: "0.85rem",
                    }}
                  >
                    These appear occasionally in quizzes to keep them fresh üîÑ
                    Tap to move back to study list.
                  </p>
                  <div className="char-grid">
                    {mastered.map((k) => {
                      const info = masteredCharData[k] || {};
                      return (
                        <div
                          key={k}
                          className="char-card"
                          style={{
                            borderColor: "var(--jade)",
                            background: "rgba(46,204,154,0.05)",
                            position: "relative",
                          }}
                          onClick={() => {
                            setMasteredChars((prev) => {
                              const n = { ...prev };
                              delete n[k];
                              return n;
                            });
                            setUnknownChars((prev) => ({
                              ...prev,
                              [k]: {
                                char: k,
                                pinyin: info.pinyin || "?",
                                meaning: info.meaning || "",
                              },
                            }));
                            showToast(`‚Ü© "${k}" moved back to study list`);
                          }}
                        >
                          <div
                            style={{
                              position: "absolute",
                              top: 6,
                              right: 6,
                              fontSize: "0.65rem",
                              color: "var(--jade-dark)",
                              fontFamily: "'Fredoka One',cursive",
                            }}
                          >
                            ‚≠ê MASTERED
                          </div>
                          <div
                            className="big-char"
                            style={{ color: "var(--jade-dark)" }}
                          >
                            {k}
                          </div>
                          <div
                            style={{
                              fontSize: "0.85rem",
                              color: "var(--jade-dark)",
                              marginBottom: 4,
                            }}
                          >
                            {info.pinyin || ""}
                          </div>
                          <div style={{ fontSize: "0.78rem", color: "#888" }}>
                            {info.meaning || ""}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          );
        };

        const renderQuizTypeSelect = () => {
          const cardBase = {
            borderRadius: 20,
            padding: "24px 20px 22px",
            cursor: "pointer",
            border: "none",
            textAlign: "left",
            transition: "transform 0.2s, box-shadow 0.2s",
            position: "relative",
            overflow: "hidden",
            display: "block",
            width: "100%",
          };
          const badge = {
            display: "inline-block",
            background: "rgba(255,255,255,0.25)",
            borderRadius: 8,
            padding: "3px 10px",
            fontSize: "0.68rem",
            color: "white",
            fontFamily: "'Fredoka One',cursive",
            marginBottom: 12,
            letterSpacing: "0.05em",
          };
          const titleS = {
            fontFamily: "'Fredoka One',cursive",
            fontSize: "1.2rem",
            color: "white",
            marginBottom: 6,
          };
          const descS = {
            fontSize: "0.78rem",
            color: "rgba(255,255,255,0.82)",
            lineHeight: 1.45,
          };
          const cards = [
            {
              type: "pinyin",
              bg: "linear-gradient(135deg,#C0392B,#922B21)",
              badge: "MULTIPLE CHOICE",
              icon: "üî§",
              name: "Pinyin Quiz",
              text: "See the character, pick the right pronunciation",
            },
            {
              type: "meaning",
              bg: "linear-gradient(135deg,#1A7A5E,#0E6655)",
              badge: "MULTIPLE CHOICE",
              icon: "üí¨",
              name: "Meaning Quiz",
              text: "See the character, find the right English meaning",
            },
            {
              type: "flashcard",
              bg: "linear-gradient(135deg,#B7770D,#9A6209)",
              badge: "SELF GRADED",
              icon: "üÉè",
              name: "Flashcards",
              text: "Flip cards and test yourself honestly",
            },
            {
              type: "writing",
              bg: "linear-gradient(135deg,#1A5276,#154360)",
              badge: "SELF GRADED",
              icon: "‚úçÔ∏è",
              name: "Writing Quiz",
              text: "See the hint, draw the character by hand",
            },
          ];
          return (
            <div style={{ maxWidth: 560, margin: "0 auto", padding: "8px 0" }}>
              <div style={{ textAlign: "center", marginBottom: 32 }}>
                <span
                  style={{
                    fontSize: "3.5rem",
                    display: "block",
                    marginBottom: 10,
                  }}
                >
                  üèÆ
                </span>
                <div
                  style={{
                    fontFamily: "'Ma Shan Zheng',cursive",
                    fontSize: "2rem",
                    color: "var(--red)",
                    marginBottom: 4,
                  }}
                >
                  ÈÄâÊã©ÁªÉ‰π†ÊñπÂºè
                </div>
                <div style={{ color: "var(--ink-light)", fontSize: "0.95rem" }}>
                  Choose how you want to practice today
                </div>
              </div>
              <div
                style={{
                  display: "grid",
                  gridTemplateColumns: "1fr 1fr",
                  gap: 14,
                  marginBottom: 24,
                }}
              >
                {cards.map((c) => (
                  <button
                    key={c.type}
                    style={{ ...cardBase, background: c.bg }}
                    onClick={() => startQuiz(c.type)}
                    onMouseEnter={(e) =>
                      (e.currentTarget.style.transform =
                        "translateY(-4px) scale(1.02)")
                    }
                    onMouseLeave={(e) => (e.currentTarget.style.transform = "")}
                  >
                    <div style={badge}>{c.badge}</div>
                    <div style={{ fontSize: "2rem", marginBottom: 8 }}>
                      {c.icon}
                    </div>
                    <div style={titleS}>{c.name}</div>
                    <div style={descS}>{c.text}</div>
                  </button>
                ))}
              </div>
              <div style={{ textAlign: "center" }}>
                <button
                  className="btn btn-outline btn-sm"
                  onClick={() => setScreen("chars")}
                >
                  ‚Ü© Back to Study List
                </button>
              </div>
            </div>
          );
        };

        const renderQuizResult = () => {
          const { answers, type } = quizState;
          const correct = answers.filter((a) => a.correct).length;
          const reviewAnswers = answers.filter((a) => a.isReview);
          const pct = Math.round((correct / answers.length) * 100);
          return (
            <div
              style={{
                maxWidth: 520,
                margin: "0 auto",
                textAlign: "center",
                padding: "20px 0",
              }}
            >
              <div style={{ fontSize: "4rem", marginBottom: 16 }}>
                {pct >= 80 ? "üéâ" : pct >= 50 ? "üòä" : "üí™"}
              </div>
              <div
                style={{
                  fontFamily: "'Fredoka One',cursive",
                  fontSize: "2rem",
                  color: "var(--ink)",
                  marginBottom: 8,
                }}
              >
                {correct}/{answers.length} correct!
              </div>
              <div style={{ color: "var(--ink-light)", marginBottom: 24 }}>
                {pct}% ‚Äî{" "}
                {pct >= 80
                  ? "Excellent!"
                  : pct >= 50
                    ? "Good job!"
                    : "Keep practising!"}
              </div>
              <div
                style={{
                  display: "flex",
                  justifyContent: "center",
                  gap: 20,
                  marginBottom: 24,
                  flexWrap: "wrap",
                }}
              >
                {[
                  { n: correct, l: "Correct", c: "var(--jade)" },
                  {
                    n: answers.length - correct,
                    l: "To Review",
                    c: "var(--red)",
                  },
                  {
                    n: Object.keys(masteredChars).length,
                    l: "Mastered",
                    c: "var(--gold)",
                  },
                ].map((s) => (
                  <div
                    key={s.l}
                    style={{
                      background: "white",
                      borderRadius: 16,
                      padding: "16px 24px",
                      boxShadow: "0 2px 12px rgba(0,0,0,0.08)",
                    }}
                  >
                    <div
                      style={{
                        fontFamily: "'Fredoka One',cursive",
                        fontSize: "2rem",
                        color: s.c,
                      }}
                    >
                      {s.n}
                    </div>
                    <div
                      style={{ fontSize: "0.8rem", color: "var(--ink-light)" }}
                    >
                      {s.l}
                    </div>
                  </div>
                ))}
              </div>
              {reviewAnswers.length > 0 && (
                <div
                  style={{
                    background: "rgba(46,204,154,0.1)",
                    border: "2px solid var(--jade)",
                    borderRadius: 16,
                    padding: "12px 20px",
                    marginBottom: 20,
                    fontSize: "0.9rem",
                    color: "var(--jade-dark)",
                  }}
                >
                  ‚≠ê {reviewAnswers.filter((a) => a.correct).length}/
                  {reviewAnswers.length} mastered review cards correct
                </div>
              )}
              <div
                style={{
                  display: "flex",
                  gap: 12,
                  justifyContent: "center",
                  flexWrap: "wrap",
                }}
              >
                <button
                  className="btn btn-red"
                  onClick={() => startQuiz(quizState.type)}
                >
                  üîÅ Try Again
                </button>
                <button
                  className="btn btn-outline"
                  onClick={() => setScreen("quiz")}
                >
                  üéÆ Choose Mode
                </button>
                <button
                  className="btn btn-jade"
                  onClick={() => setScreen("chars")}
                >
                  üìã Study List
                </button>
              </div>
            </div>
          );
        };

        const renderWritingQuiz = () => {
          const { questions, current, revealed, answers } = quizState;
          const item = questions[current];
          const sz = Math.min(window.innerWidth - 80, 280);
          return (
            <div style={{ maxWidth: 520, margin: "0 auto" }}>
              <div
                style={{
                  display: "flex",
                  gap: 6,
                  marginBottom: 24,
                  flexWrap: "wrap",
                }}
              >
                {questions.map((_, i) => (
                  <div
                    key={i}
                    className={`progress-dot ${i < answers.length ? (answers[i].correct ? "correct" : "wrong") : ""} ${i === current ? "current" : ""}`}
                  />
                ))}
              </div>
              <div
                style={{
                  textAlign: "center",
                  marginBottom: 12,
                  color: "var(--ink-light)",
                  fontSize: "0.85rem",
                  fontFamily: "'Fredoka One',cursive",
                }}
              >
                {current + 1} / {questions.length}
              </div>
              <div
                style={{
                  background: "white",
                  borderRadius: 28,
                  padding: "28px 32px",
                  textAlign: "center",
                  boxShadow: "0 8px 32px rgba(0,0,0,0.1)",
                  marginBottom: 16,
                  position: "relative",
                  overflow: "hidden",
                }}
              >
                <div
                  style={{
                    position: "absolute",
                    top: 0,
                    left: 0,
                    right: 0,
                    height: 6,
                    background:
                      "linear-gradient(90deg,var(--sky),var(--jade),var(--gold))",
                  }}
                />
                {item.isReview && (
                  <div
                    style={{
                      position: "absolute",
                      top: 14,
                      right: 16,
                      background: "rgba(46,204,154,0.15)",
                      border: "1px solid var(--jade)",
                      borderRadius: 8,
                      padding: "3px 10px",
                      fontSize: "0.7rem",
                      color: "var(--jade-dark)",
                      fontFamily: "'Fredoka One',cursive",
                    }}
                  >
                    ‚≠ê REVIEW
                  </div>
                )}
                <div
                  style={{
                    fontSize: "2rem",
                    color: "var(--red)",
                    fontWeight: 700,
                    marginBottom: 6,
                  }}
                >
                  {item.pinyin}
                </div>
                <div style={{ color: "var(--ink-light)" }}>{item.meaning}</div>
                <div
                  style={{ fontSize: "0.8rem", color: "#bbb", marginTop: 6 }}
                >
                  ‚úçÔ∏è Write the character below
                </div>
              </div>
              <div style={{ textAlign: "center" }}>
                <div
                  style={{
                    position: "relative",
                    display: "inline-block",
                    marginBottom: 16,
                  }}
                >
                  <canvas
                    ref={canvasRef}
                    width={sz}
                    height={sz}
                    className="writing-canvas"
                    style={{ width: sz, height: sz }}
                    onMouseDown={startDraw}
                    onMouseMove={draw}
                    onMouseUp={endDraw}
                    onMouseLeave={endDraw}
                    onTouchStart={startDraw}
                    onTouchMove={draw}
                    onTouchEnd={endDraw}
                  />
                  <svg
                    style={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      pointerEvents: "none",
                      borderRadius: 14,
                    }}
                    width={sz}
                    height={sz}
                  >
                    <line
                      x1={sz / 2}
                      y1="8"
                      x2={sz / 2}
                      y2={sz - 8}
                      stroke="#f0e8e0"
                      strokeWidth="1.5"
                      strokeDasharray="6,4"
                    />
                    <line
                      x1="8"
                      y1={sz / 2}
                      x2={sz - 8}
                      y2={sz / 2}
                      stroke="#f0e8e0"
                      strokeWidth="1.5"
                      strokeDasharray="6,4"
                    />
                    <line
                      x1="8"
                      y1="8"
                      x2={sz - 8}
                      y2={sz - 8}
                      stroke="#f0e8e0"
                      strokeWidth="1"
                      strokeDasharray="4,6"
                    />
                    <line
                      x1={sz - 8}
                      y1="8"
                      x2="8"
                      y2={sz - 8}
                      stroke="#f0e8e0"
                      strokeWidth="1"
                      strokeDasharray="4,6"
                    />
                  </svg>
                </div>
              </div>
              <div
                style={{
                  display: "flex",
                  gap: 10,
                  justifyContent: "center",
                  marginBottom: 16,
                  flexWrap: "wrap",
                }}
              >
                <button
                  className="btn btn-outline btn-sm"
                  onClick={clearCanvas}
                >
                  üóëÔ∏è Clear
                </button>
                {!revealed && (
                  <button
                    className="btn btn-gold"
                    onClick={() =>
                      setQuizState((p) => ({ ...p, revealed: true }))
                    }
                  >
                    üëÄ Reveal Answer
                  </button>
                )}
              </div>
              {revealed && (
                <>
                  <div
                    style={{
                      background: "rgba(192,57,43,0.06)",
                      border: "2px solid var(--red)",
                      borderRadius: 20,
                      padding: "16px 24px",
                      textAlign: "center",
                      marginBottom: 16,
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      gap: 20,
                    }}
                  >
                    <div
                      style={{
                        fontFamily: "'Ma Shan Zheng',cursive",
                        fontSize: "5rem",
                        color: "var(--red)",
                        lineHeight: 1,
                      }}
                    >
                      {item.char}
                    </div>
                    <div style={{ textAlign: "left" }}>
                      <div
                        style={{
                          fontSize: "1.1rem",
                          color: "var(--ink)",
                          fontWeight: 500,
                        }}
                      >
                        {item.pinyin}
                      </div>
                      <div
                        style={{
                          fontSize: "0.9rem",
                          color: "var(--ink-light)",
                          marginTop: 4,
                        }}
                      >
                        {item.meaning}
                      </div>
                    </div>
                  </div>
                  <div
                    style={{
                      display: "flex",
                      gap: 10,
                      justifyContent: "center",
                      marginBottom: 12,
                    }}
                  >
                    <button
                      className="btn btn-red"
                      onClick={() => handleFlashcard(false)}
                    >
                      üòÖ Not quite
                    </button>
                    <button
                      className="btn btn-jade"
                      onClick={() => handleFlashcard(true)}
                    >
                      üåü Got it!
                    </button>
                  </div>
                </>
              )}
              <div style={{ textAlign: "center" }}>
                <button
                  className="btn btn-outline btn-sm"
                  onClick={() => {
                    clearCanvas();
                    setQuizState(null);
                  }}
                >
                  ‚Ü© Change Mode
                </button>
              </div>
            </div>
          );
        };

        const renderQuizActive = () => {
          const {
            questions,
            current,
            type,
            options,
            revealed,
            selectedOption,
            answers,
          } = quizState;
          const item = questions[current];
          if (type === "writing") return renderWritingQuiz();
          const isFlash = type === "flashcard";
          return (
            <div style={{ maxWidth: 520, margin: "0 auto" }}>
              <div
                style={{
                  display: "flex",
                  gap: 6,
                  marginBottom: 24,
                  flexWrap: "wrap",
                }}
              >
                {questions.map((_, i) => (
                  <div
                    key={i}
                    className={`progress-dot ${i < answers.length ? (answers[i].correct ? "correct" : "wrong") : ""} ${i === current ? "current" : ""}`}
                  />
                ))}
              </div>
              <div
                style={{
                  textAlign: "center",
                  marginBottom: 8,
                  color: "var(--ink-light)",
                  fontSize: "0.85rem",
                  fontFamily: "'Fredoka One',cursive",
                }}
              >
                {current + 1} / {questions.length}
              </div>
              <div className="quiz-card">
                {item.isReview && (
                  <div
                    style={{
                      position: "absolute",
                      top: 14,
                      right: 16,
                      background: "rgba(46,204,154,0.15)",
                      border: "1px solid var(--jade)",
                      borderRadius: 8,
                      padding: "3px 10px",
                      fontSize: "0.7rem",
                      color: "var(--jade-dark)",
                      fontFamily: "'Fredoka One',cursive",
                    }}
                  >
                    ‚≠ê REVIEW
                  </div>
                )}
                <div
                  style={{
                    fontSize: "0.82rem",
                    color: "#aaa",
                    textTransform: "uppercase",
                    letterSpacing: "0.1em",
                    marginBottom: 16,
                  }}
                >
                  {isFlash
                    ? "What's the pinyin & meaning?"
                    : type === "pinyin"
                      ? "Pick the correct pinyin"
                      : "Pick the correct meaning"}
                </div>
                <div className="quiz-char">{item.char}</div>
                {isFlash && (
                  <div
                    style={{
                      fontSize: "1.1rem",
                      color: revealed ? "var(--red)" : "transparent",
                      marginTop: 8,
                      minHeight: 28,
                      fontWeight: 500,
                    }}
                  >
                    {revealed ? (
                      <div>
                        <div>{item.pinyin}</div>
                        <div
                          style={{
                            fontSize: "0.9rem",
                            color: "#888",
                            marginTop: 4,
                          }}
                        >
                          {item.meaning}
                        </div>
                      </div>
                    ) : (
                      "‚Ä¢‚Ä¢‚Ä¢"
                    )}
                  </div>
                )}
              </div>
              {isFlash ? (
                revealed ? (
                  <div
                    style={{
                      display: "flex",
                      gap: 10,
                      justifyContent: "center",
                    }}
                  >
                    <button
                      className="btn btn-red"
                      onClick={() => handleFlashcard(false)}
                    >
                      üòÖ Not quite
                    </button>
                    <button
                      className="btn btn-jade"
                      onClick={() => handleFlashcard(true)}
                    >
                      üåü Got it!
                    </button>
                  </div>
                ) : (
                  <div style={{ textAlign: "center" }}>
                    <button
                      className="btn btn-gold"
                      onClick={() =>
                        setQuizState((p) => ({ ...p, revealed: true }))
                      }
                    >
                      üëÄ Flip Card
                    </button>
                  </div>
                )
              ) : (
                <div className="quiz-options">
                  {options.map((opt, i) => {
                    const isChosen =
                      selectedOption && opt.char === quizState.chosenChar;
                    const isCorrect = selectedOption && opt.char === item.char;
                    return (
                      <button
                        key={i}
                        className={`option-btn${isCorrect ? " correct" : isChosen && !isCorrect ? " wrong" : ""}`}
                        disabled={!!selectedOption}
                        onClick={() => {
                          setQuizState((p) => ({ ...p, chosenChar: opt.char }));
                          handleAnswer(opt);
                        }}
                      >
                        <div style={{ fontWeight: 600 }}>
                          {type === "pinyin" ? opt.pinyin : opt.meaning || "‚Äî"}
                        </div>
                        {type === "meaning" && (
                          <div
                            style={{
                              fontSize: "0.8rem",
                              opacity: 0.7,
                              marginTop: 2,
                            }}
                          >
                            {opt.pinyin}
                          </div>
                        )}
                      </button>
                    );
                  })}
                </div>
              )}
              <div style={{ textAlign: "center", marginTop: 16 }}>
                <button
                  className="btn btn-outline btn-sm"
                  onClick={() => setQuizState(null)}
                >
                  ‚Ü© Change Mode
                </button>
              </div>
            </div>
          );
        };

        const renderQuiz = () => {
          if (!quizState) return renderQuizTypeSelect();
          if (quizState.done) return renderQuizResult();
          return renderQuizActive();
        };

        // ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const onRead = screen === "home" || screen === "reading";
        const onChars = screen === "chars" || screen === "quiz";

        return (
          <div className="app">
            <div className="header">
              <div className="logo">
                üèÆ <span>Â∞èÂ≠¶ËÄÖ</span>
              </div>
              <div
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: 8,
                  flexWrap: "wrap",
                }}
              >
                <div className="nav-tabs">
                  <button
                    className={`nav-tab${onRead ? " active" : ""}`}
                    onClick={() => {
                      ttsStop();
                      setScreen("home");
                    }}
                  >
                    üìñ Read
                  </button>
                  <button
                    className={`nav-tab${onChars ? " active" : ""}`}
                    onClick={() => {
                      ttsStop();
                      setScreen("chars");
                    }}
                  >
                    üìã Study List
                    {unknownCount > 0 && (
                      <span className="count-badge">{unknownCount}</span>
                    )}
                  </button>
                </div>
                <button
                  className="btn btn-outline btn-sm"
                  title="Logout"
                  onClick={async () => {
                    await apiLogout();
                    onLogout();
                  }}
                >
                  üö™
                </button>
              </div>
            </div>

            {loading && (
              <div className="loading-card">
                <div className="loading-chars">
                  {"Â≠¶‰π†‰∏≠ÊñáÈòÖËØª".split("").map((c, i) => (
                    <span
                      key={i}
                      className="loading-char"
                      style={{ animationDelay: `${i * 0.15}s` }}
                    >
                      {c}
                    </span>
                  ))}
                </div>
                <div
                  style={{
                    fontFamily: "'Fredoka One',cursive",
                    color: "var(--ink-light)",
                  }}
                >
                  {loadingMsg}
                </div>
              </div>
            )}

            {!loading && screen === "home" && renderHome()}
            {!loading && screen === "reading" && renderReading()}
            {!loading && screen === "chars" && renderChars()}
            {!loading && screen === "quiz" && renderQuiz()}

            {tooltip.visible && tooltip.char && (
              <div
                className="char-tooltip"
                style={{ left: tooltip.x, top: tooltip.y }}
              >
                <div
                  style={{
                    fontFamily: "'Ma Shan Zheng',cursive",
                    fontSize: "1.6rem",
                  }}
                >
                  {tooltip.char.char}
                </div>
                <div style={{ opacity: 0.8, fontSize: "0.9rem" }}>
                  {tooltip.char.pinyin}
                </div>
                <div style={{ color: "#ddd", fontSize: "0.8rem" }}>
                  {tooltip.char.meaning}
                </div>
              </div>
            )}

            <div className={`toast${toast.show ? " show" : ""}`}>
              {toast.msg}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<Root />);
    </script>
  </body>
</html>
