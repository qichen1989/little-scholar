<!doctype html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Â∞èÂ≠¶ËÄÖ Little Scholar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@300;400;500;700&family=Fredoka+One&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      :root {
        --red: #c0392b;
        --red-light: #e74c3c;
        --gold: #f0a500;
        --gold-light: #f7c948;
        --cream: #fff8f0;
        --ink: #2c1a0e;
        --ink-light: #5c3d2e;
        --jade: #2ecc9a;
        --jade-dark: #1a9970;
        --sky: #5bc8f5;
        --bg: #fff3e8;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Noto Sans SC", sans-serif;
        background: var(--bg);
        min-height: 100vh;
      }
      .app {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0 20px;
        border-bottom: 3px solid var(--red);
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .logo {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 2rem;
        color: var(--red);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .nav-tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .nav-tab {
        padding: 8px 14px;
        border-radius: 20px;
        border: 2px solid var(--red);
        background: transparent;
        color: var(--red);
        font-family: "Fredoka One", cursive;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .nav-tab:hover,
      .nav-tab.active {
        background: var(--red);
        color: white;
      }
      .count-badge {
        background: var(--gold);
        color: var(--ink);
        border-radius: 10px;
        padding: 1px 6px;
        font-size: 0.75rem;
        margin-left: 4px;
      }
      .upload-area {
        border: 3px dashed var(--gold);
        border-radius: 24px;
        padding: 60px 40px;
        text-align: center;
        background: rgba(240, 165, 0, 0.05);
        cursor: pointer;
        transition: all 0.3s;
      }
      .upload-area:hover,
      .upload-area.drag-over {
        background: rgba(240, 165, 0, 0.12);
        border-color: var(--red);
        transform: scale(1.01);
      }
      .upload-icon {
        font-size: 4rem;
        margin-bottom: 16px;
        display: block;
        animation: float 3s ease-in-out infinite;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }
      .upload-title {
        font-family: "Fredoka One", cursive;
        font-size: 1.6rem;
        color: var(--ink);
        margin-bottom: 8px;
      }
      .upload-sub {
        color: var(--ink-light);
        font-size: 0.95rem;
      }
      .welcome-banner {
        background: linear-gradient(135deg, #c0392b, #8b1a1a);
        border-radius: 20px;
        padding: 24px 28px;
        color: white;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 20px;
        position: relative;
        overflow: hidden;
      }
      .welcome-banner::before {
        content: "Á¶è";
        position: absolute;
        right: 20px;
        top: -10px;
        font-family: "Ma Shan Zheng", cursive;
        font-size: 8rem;
        opacity: 0.1;
        color: var(--gold);
        pointer-events: none;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 20px;
        border-radius: 20px;
        border: none;
        font-family: "Fredoka One", cursive;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .btn-red {
        background: var(--red);
        color: white;
      }
      .btn-gold {
        background: var(--gold);
        color: var(--ink);
      }
      .btn-jade {
        background: var(--jade);
        color: white;
      }
      .btn-outline {
        background: white;
        color: var(--red);
        border: 2px solid var(--red);
      }
      .btn-sm {
        padding: 6px 14px;
        font-size: 0.85rem;
      }
      .loading-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 8px 30px rgba(192, 57, 43, 0.12);
      }
      .loading-chars {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin: 24px 0;
        flex-wrap: wrap;
      }
      .loading-char {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 2.5rem;
        color: var(--red);
        animation: bounce 1.2s ease-in-out infinite;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }
        50% {
          transform: translateY(-16px) rotate(5deg);
        }
      }
      .article-text {
        background: white;
        border-radius: 20px;
        padding: 28px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.07);
        line-height: 3.2;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: flex-start;
      }
      .char-block {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        border-radius: 8px;
        padding: 4px 3px 2px;
        transition: all 0.2s;
        min-width: 36px;
      }
      .char-block:hover {
        background: rgba(240, 165, 0, 0.15);
        transform: scale(1.08);
      }
      .char-block.unknown {
        background: rgba(192, 57, 43, 0.12);
        border: 2px solid var(--red);
      }
      .char-block.unknown .char-zh {
        color: var(--red);
      }
      .char-block.punct {
        cursor: default;
        min-width: auto;
        padding: 4px 1px;
      }
      .char-block.punct:hover {
        background: none;
        transform: none;
      }
      .char-pinyin {
        font-size: 0.72rem;
        color: var(--ink-light);
        min-height: 14px;
        line-height: 1;
        margin-bottom: 1px;
      }
      .char-zh {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 1.6rem;
        line-height: 1;
        color: var(--ink);
      }
      .unknown-dot {
        width: 6px;
        height: 6px;
        background: var(--red);
        border-radius: 50%;
        margin-top: 2px;
      }
      .reading-hint {
        background: var(--gold-light);
        border-radius: 12px;
        padding: 10px 16px;
        font-size: 0.88rem;
        color: var(--ink);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .char-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }
      .char-card {
        background: white;
        border-radius: 16px;
        padding: 16px 12px;
        text-align: center;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }
      .char-card:hover {
        border-color: var(--gold);
        transform: translateY(-3px);
      }
      .big-char {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 2.8rem;
        color: var(--ink);
        line-height: 1;
        margin-bottom: 6px;
      }
      .section-title {
        font-family: "Fredoka One", cursive;
        font-size: 1.3rem;
        color: var(--ink);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .quiz-card {
        background: white;
        border-radius: 28px;
        padding: 40px 32px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
        min-height: 260px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }
      .quiz-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(
          90deg,
          var(--red),
          var(--gold),
          var(--jade)
        );
      }
      .quiz-char {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 6rem;
        color: var(--ink);
        line-height: 1;
      }
      .quiz-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 16px;
      }
      .option-btn {
        padding: 14px 10px;
        border-radius: 16px;
        border: 2px solid #e8ddd5;
        background: white;
        font-family: "Noto Sans SC", sans-serif;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .option-btn:hover:not(:disabled) {
        border-color: var(--gold);
        background: rgba(240, 165, 0, 0.08);
      }
      .option-btn.correct {
        background: rgba(46, 204, 154, 0.15);
        border-color: var(--jade);
        color: var(--jade-dark);
      }
      .option-btn.wrong {
        background: rgba(231, 76, 60, 0.12);
        border-color: var(--red-light);
        color: var(--red);
      }
      .progress-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #e0d6cc;
        transition: all 0.3s;
      }
      .progress-dot.correct {
        background: var(--jade);
      }
      .progress-dot.wrong {
        background: var(--red-light);
      }
      .progress-dot.current {
        background: var(--gold);
        transform: scale(1.3);
      }
      .writing-canvas {
        border-radius: 16px;
        border: 3px solid var(--gold);
        cursor: crosshair;
        display: block;
        touch-action: none;
        background: white;
      }
      .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--ink);
        color: white;
        padding: 12px 24px;
        border-radius: 20px;
        font-family: "Fredoka One", cursive;
        font-size: 0.95rem;
        z-index: 9999;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        white-space: nowrap;
      }
      .toast.show {
        transform: translateX(-50%) translateY(0);
      }
      .char-tooltip {
        position: fixed;
        background: var(--ink);
        color: white;
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 0.85rem;
        pointer-events: none;
        z-index: 1000;
        max-width: 200px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        transform: translateX(-50%) translateY(-110%);
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--ink-light);
      }
      @media (max-width: 500px) {
        .char-zh {
          font-size: 1.3rem;
        }
        .quiz-char {
          font-size: 4rem;
        }
        .nav-tab {
          padding: 6px 10px;
          font-size: 0.8rem;
        }
      }

      /* TTS player bar */
      .tts-bar {
        position: sticky;
        bottom: 16px;
        margin-top: 20px;
        background: white;
        border-radius: 20px;
        padding: 14px 20px;
        box-shadow: 0 4px 24px rgba(192, 57, 43, 0.15);
        border: 2px solid var(--gold-light);
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .tts-btn {
        background: var(--red);
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        font-size: 1.2rem;
        cursor: pointer;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.15s;
      }
      .tts-btn:hover {
        transform: scale(1.1);
      }
      .tts-btn.secondary {
        background: var(--gold);
        font-size: 1rem;
      }
      .tts-progress {
        flex: 1;
        min-width: 120px;
      }
      .tts-progress-bar {
        height: 10px;
        background: #f0e8e0;
        border-radius: 5px;
        margin-bottom: 4px;
        cursor: pointer;
        position: relative;
      }
      .tts-progress-bar:hover {
        background: #e8ddd5;
      }
      .tts-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--red), var(--gold));
        border-radius: 5px;
        transition: width 0.2s;
        pointer-events: none;
        position: relative;
      }
      .tts-progress-fill::after {
        content: "";
        position: absolute;
        right: -6px;
        top: 50%;
        transform: translateY(-50%);
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--red);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
      }
      .tts-label {
        font-size: 0.72rem;
        color: var(--ink-light);
        font-family: "Fredoka One", cursive;
      }
      .tts-speed {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: var(--ink-light);
      }
      .tts-speed select {
        border: 2px solid #e8ddd5;
        border-radius: 8px;
        padding: 4px 8px;
        font-family: "Fredoka One", cursive;
        font-size: 0.8rem;
        background: white;
        cursor: pointer;
      }
      .char-block.speaking {
        background: rgba(240, 165, 0, 0.3);
        border-radius: 6px;
        transform: scale(1.15);
      }

      /* Login screen */
      .login-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          #8b1a1a 0%,
          #c0392b 50%,
          #f0a500 100%
        );
        padding: 20px;
      }
      .login-card {
        background: white;
        border-radius: 28px;
        padding: 40px 36px;
        width: 100%;
        max-width: 380px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      .login-logo {
        font-family: "Ma Shan Zheng", cursive;
        font-size: 3rem;
        color: var(--red);
        margin-bottom: 4px;
      }
      .login-subtitle {
        font-family: "Fredoka One", cursive;
        font-size: 1rem;
        color: var(--ink-light);
        margin-bottom: 32px;
      }
      .login-label {
        font-family: "Fredoka One", cursive;
        font-size: 0.85rem;
        color: var(--ink-light);
        text-align: left;
        display: block;
        margin-bottom: 6px;
      }
      .login-input {
        width: 100%;
        padding: 14px 16px;
        border-radius: 14px;
        border: 2px solid #e8ddd5;
        font-size: 1.1rem;
        outline: none;
        font-family: "Noto Sans SC", sans-serif;
        transition: border-color 0.2s;
        margin-bottom: 20px;
        letter-spacing: 0.1em;
      }
      .login-input:focus {
        border-color: var(--red);
      }
      .login-btn {
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: none;
        background: linear-gradient(135deg, var(--red), #922b21);
        color: white;
        font-family: "Fredoka One", cursive;
        font-size: 1.1rem;
        cursor: pointer;
        transition:
          opacity 0.2s,
          transform 0.2s;
      }
      .login-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .login-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .login-error {
        color: var(--red);
        font-size: 0.85rem;
        margin-top: 12px;
        font-family: "Fredoka One", cursive;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useRef, useCallback, useEffect } = React;

      const STORAGE = { unknown: "ls-unknown", mastered: "ls-mastered" };
      const shuffle = (a) => [...a].sort(() => Math.random() - 0.5);
      const isChinese = (ch) => /[\u4e00-\u9fff\u3400-\u4dbf]/.test(ch);
      const isPunct = (ch) =>
        /[\uff0c\u3002\uff01\uff1f\u3001\uff1b\uff1a\u201c\u201d\u2018\u2019\u300c\u300d\u3010\u3011\uff08\uff09\u2026\u2014\u00b7.,!?;:()/\[\]]/.test(
          ch,
        );

      // ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function apiOcr(base64) {
        const res = await fetch("/api/ocr", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image_base64: base64 }),
        });
        if (res.status === 401) throw new Error("SESSION_EXPIRED");
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "OCR failed");
        return data.text;
      }

      async function apiLookup(characters) {
        const res = await fetch("/api/lookup", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ characters }),
        });
        if (res.status === 401) throw new Error("SESSION_EXPIRED");
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Lookup failed");
        return data.lookup;
      }

      async function apiCheckAuth() {
        const res = await fetch("/api/me", { credentials: "include" });
        const data = await res.json();
        return data.authenticated;
      }

      async function apiLogin(password) {
        const res = await fetch("/api/login", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Login failed");
        return true;
      }

      async function apiLogout() {
        await fetch("/api/logout", { method: "POST", credentials: "include" });
      }

      // ‚îÄ‚îÄ Image preprocessing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function preprocessImage(dataUrl) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onerror = () => reject(new Error("Could not load image"));
          img.onload = () => {
            try {
              // Cap at 1200px ‚Äî enough for OCR, safe on mobile memory
              const MAX = 1200;
              let w = img.width,
                h = img.height;
              if (Math.max(w, h) > MAX) {
                const scale = MAX / Math.max(w, h);
                w = Math.round(w * scale);
                h = Math.round(h * scale);
              }
              const canvas = document.createElement("canvas");
              canvas.width = w;
              canvas.height = h;
              const ctx = canvas.getContext("2d");
              ctx.imageSmoothingEnabled = true;
              ctx.imageSmoothingQuality = "high";
              ctx.drawImage(img, 0, 0, w, h);
              // Lightweight grayscale ‚Äî no pixel array manipulation to save memory on mobile
              // Google Vision handles contrast internally so we just resize + convert format
              resolve(canvas.toDataURL("image/jpeg", 0.92).split(",")[1]);
            } catch (err) {
              reject(err);
            }
          };
          img.src = dataUrl;
        });
      }

      // ‚îÄ‚îÄ Tiny thumbnail for history (max 120px, ~3KB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function makeThumbnail(dataUrl) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const MAX = 120;
            const scale = Math.min(1, MAX / Math.max(img.width, img.height));
            const canvas = document.createElement("canvas");
            canvas.width = Math.round(img.width * scale);
            canvas.height = Math.round(img.height * scale);
            canvas
              .getContext("2d")
              .drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL("image/jpeg", 0.6));
          };
          img.onerror = () => resolve(null);
          img.src = dataUrl;
        });
      }

      // ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function LoginScreen({ onLogin }) {
        const [password, setPassword] = useState("");
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!password) return;
          setLoading(true);
          setError("");
          try {
            await apiLogin(password);
            onLogin();
          } catch (err) {
            setError("Wrong password ‚Äî try again! üîí");
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="login-screen">
            <div className="login-card">
              <div style={{ fontSize: "4rem", marginBottom: 8 }}>üèÆ</div>
              <div className="login-logo">Â∞èÂ≠¶ËÄÖ</div>
              <div className="login-subtitle">
                Little Scholar ‚Äî Chinese Reading App
              </div>
              <form onSubmit={handleSubmit}>
                <label className="login-label">
                  Enter your password to continue
                </label>
                <input
                  className="login-input"
                  type="password"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  autoFocus
                />
                <button
                  className="login-btn"
                  type="submit"
                  disabled={loading || !password}
                >
                  {loading ? "Checking‚Ä¶" : "‚ú® Let me in!"}
                </button>
                {error && <div className="login-error">{error}</div>}
              </form>
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ Auth wrapper ‚Äî owns the authed state so App() hooks are always called ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function Root() {
        const [authed, setAuthed] = useState(null); // null=checking, false=login, true=app

        useEffect(() => {
          apiCheckAuth().then((ok) => setAuthed(ok));
        }, []);

        if (authed === null)
          return (
            <div
              style={{
                minHeight: "100vh",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                background: "linear-gradient(135deg,#8B1A1A,#C0392B,#F0A500)",
              }}
            >
              <div
                style={{
                  fontFamily: "'Ma Shan Zheng',cursive",
                  fontSize: "3rem",
                  color: "white",
                  opacity: 0.8,
                }}
              >
                üèÆ
              </div>
            </div>
          );
        if (!authed) return <LoginScreen onLogin={() => setAuthed(true)} />;
        return <App onLogout={() => setAuthed(false)} />;
      }

      // ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function App({ onLogout }) {
        const [screen, setScreen] = useState("home");
        const [parsedArticle, setParsedArticle] = useState(null);
        const [imageDataUrl, setImageDataUrl] = useState(null);
        const [loading, setLoading] = useState(false);
        const [loadingMsg, setLoadingMsg] = useState("");
        const [unknownChars, setUnknownChars] = useState(() => {
          try {
            return JSON.parse(localStorage.getItem(STORAGE.unknown) || "{}");
          } catch {
            return {};
          }
        });
        const [masteredChars, setMasteredChars] = useState(() => {
          try {
            return JSON.parse(localStorage.getItem(STORAGE.mastered) || "{}");
          } catch {
            return {};
          }
        });
        const [masteredCharData, setMasteredCharData] = useState(() => {
          try {
            return JSON.parse(localStorage.getItem("ls-mastered-data") || "{}");
          } catch {
            return {};
          }
        });
        const [articleHistory, setArticleHistory] = useState(() => {
          try {
            return JSON.parse(localStorage.getItem("ls-history") || "[]");
          } catch {
            return [];
          }
        });
        const [quizState, setQuizState] = useState(null);
        const [toast, setToast] = useState({ msg: "", show: false });
        const [tooltip, setTooltip] = useState({
          visible: false,
          char: null,
          x: 0,
          y: 0,
        });
        const canvasRef = useRef();
        const isDrawing = useRef(false);
        const lastPos = useRef(null);
        const fileRef = useRef();
        const [tts, setTts] = useState({
          playing: false,
          sentenceIdx: -1,
          rate: 0.8,
          voiceURI: "",
        });
        const [availableVoices, setAvailableVoices] = useState([]);
        const ttsToken = useRef(0); // incremented on every stop ‚Äî stale closures self-abort

        useEffect(() => {
          localStorage.setItem(STORAGE.unknown, JSON.stringify(unknownChars));
        }, [unknownChars]);
        useEffect(() => {
          localStorage.setItem(STORAGE.mastered, JSON.stringify(masteredChars));
        }, [masteredChars]);
        useEffect(() => {
          localStorage.setItem(
            "ls-mastered-data",
            JSON.stringify(masteredCharData),
          );
        }, [masteredCharData]);
        useEffect(() => {
          localStorage.setItem("ls-history", JSON.stringify(articleHistory));
        }, [articleHistory]);

        const showToast = (msg) => {
          setToast({ msg, show: true });
          setTimeout(() => setToast((t) => ({ ...t, show: false })), 2200);
        };
        const unknownCount = Object.keys(unknownChars).length;

        // ‚îÄ‚îÄ File handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const handleFile = async (file) => {
          if (!file) return;
          setLoading(true);
          const reader = new FileReader();
          reader.onload = async (e) => {
            const dataUrl = e.target.result;
            setImageDataUrl(dataUrl);
            try {
              setLoadingMsg("Enhancing image‚Ä¶ ‚ú®");
              const base64 = await preprocessImage(dataUrl);

              setLoadingMsg("Reading with Google Vision‚Ä¶ üìñ");
              const articleText = await apiOcr(base64);

              const unique = [
                ...new Set(articleText.split("").filter(isChinese)),
              ];
              const lookup = {};
              const BATCH = 50;
              for (let i = 0; i < unique.length; i += BATCH) {
                setLoadingMsg(
                  `Looking up pinyin‚Ä¶ ${Math.min(i + BATCH, unique.length)}/${unique.length} üîç`,
                );
                const batch = unique.slice(i, i + BATCH);
                const result = await apiLookup(batch);
                Object.assign(lookup, result);
              }

              const arr = [];
              for (const ch of articleText) {
                if (ch === "\n") arr.push({ char: "\n", type: "break" });
                else if (" \t\r".includes(ch)) continue;
                else if (isPunct(ch)) arr.push({ char: ch, type: "punct" });
                else if (isChinese(ch)) {
                  const info = lookup[ch] || {};
                  arr.push({
                    char: ch,
                    pinyin: info.pinyin || "?",
                    meaning: info.meaning || "",
                  });
                } else arr.push({ char: ch, type: "latin" });
              }
              setParsedArticle(arr);
              // Save to history (keep last 10, store thumbnail + first 40 chars of text)
              const preview = articleText
                .replace(/\s+/g, " ")
                .trim()
                .slice(0, 60);
              const entry = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                preview,
                thumb: dataUrl,
                arr,
              };
              setArticleHistory((prev) =>
                [entry, ...prev.filter((h) => h.id !== entry.id)].slice(0, 10),
              );
              setScreen("reading");
            } catch (err) {
              console.error(err);
              if (err.message === "SESSION_EXPIRED") {
                onLogout();
                return;
              }
              showToast("‚ö†Ô∏è " + (err.message || "Something went wrong"));
            } finally {
              setLoading(false);
            }
          };
          reader.readAsDataURL(file);
        };

        const onDrop = useCallback((e) => {
          e.preventDefault();
          const file = e.dataTransfer.files[0];
          if (file?.type.startsWith("image/")) handleFile(file);
        }, []);

        // ‚îÄ‚îÄ Character management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const toggleUnknown = (item) => {
          if (!item.char || item.type === "punct" || item.type === "break")
            return;
          setUnknownChars((prev) => {
            const next = { ...prev };
            if (next[item.char]) {
              delete next[item.char];
              showToast(`‚úÖ Removed "${item.char}"`);
            } else {
              next[item.char] = {
                char: item.char,
                pinyin: item.pinyin,
                meaning: item.meaning,
              };
              showToast(`üìå Added "${item.char}"`);
            }
            return next;
          });
        };
        const markMastered = (key) => {
          const charInfo = unknownChars[key] || {};
          setMasteredChars((prev) => ({ ...prev, [key]: true }));
          setMasteredCharData((prev) => ({ ...prev, [key]: charInfo }));
          setUnknownChars((prev) => {
            const n = { ...prev };
            delete n[key];
            return n;
          });
          showToast(
            `üåü "${key}" mastered ‚Äî will appear occasionally in quizzes!`,
          );
        };
        const removeChar = (key) => {
          setUnknownChars((prev) => {
            const n = { ...prev };
            delete n[key];
            return n;
          });
          setMasteredChars((prev) => {
            const n = { ...prev };
            delete n[key];
            return n;
          });
        };

        // ‚îÄ‚îÄ Quiz (with spaced repetition for mastered chars) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const REVIEW_RATE = 0.25; // ~1 in 4 questions is a mastered review card

        const buildQuestionList = () => {
          const active = shuffle(Object.values(unknownChars));
          const mastered = shuffle(
            Object.keys(masteredChars).map((k) => ({
              char: k,
              ...(masteredCharData[k] || { pinyin: "?", meaning: "" }),
              isReview: true,
            })),
          );
          if (mastered.length === 0)
            return active.map((c) => ({ ...c, isReview: false }));
          const result = [];
          let mi = 0;
          for (let i = 0; i < active.length; i++) {
            result.push({ ...active[i], isReview: false });
            if (
              (i + 1) % Math.round(1 / REVIEW_RATE) === 0 &&
              mi < mastered.length
            )
              result.push({ ...mastered[mi++] });
          }
          return result;
        };

        const buildOptions = (correct, pool, type) =>
          shuffle([
            correct,
            ...shuffle(pool.filter((c) => c.char !== correct.char)).slice(0, 3),
          ]);

        const startQuiz = (type) => {
          const chars = Object.values(unknownChars);
          if (chars.length < 2) {
            showToast("Add at least 2 characters first!");
            return;
          }
          const questions = buildQuestionList();
          const pool = [
            ...Object.values(unknownChars),
            ...Object.keys(masteredChars).map((k) => ({
              char: k,
              ...(masteredCharData[k] || {}),
            })),
          ];
          setQuizState({
            type,
            questions,
            current: 0,
            answers: [],
            options: buildOptions(questions[0], pool, type),
            revealed: false,
            selectedOption: null,
            pool,
          });
        };

        const handleAnswer = (chosen) => {
          const { questions, current, type, answers, pool } = quizState;
          const correct = questions[current];
          const isCorrect =
            type === "pinyin"
              ? chosen.pinyin === correct.pinyin
              : chosen.meaning === correct.meaning;
          const newAnswers = [
            ...answers,
            {
              correct: isCorrect,
              char: correct.char,
              isReview: correct.isReview,
            },
          ];
          // Step 1: show feedback on the CURRENT question (don't advance current yet)
          setQuizState((p) => ({
            ...p,
            answers: newAnswers,
            selectedOption: isCorrect ? "correct" : "wrong",
            chosenChar: chosen.char,
          }));
          // Step 2: after delay, advance to next question
          setTimeout(() => {
            setQuizState((p) => {
              if (!p) return p;
              const next = current + 1;
              if (next >= questions.length)
                return {
                  ...p,
                  done: true,
                  selectedOption: null,
                  chosenChar: null,
                };
              return {
                ...p,
                current: next,
                options: buildOptions(questions[next], pool, type),
                selectedOption: null,
                chosenChar: null,
                revealed: false,
              };
            });
          }, 850);
        };

        const handleFlashcard = (knew) => {
          const { questions, current, answers, pool, type } = quizState;
          const item = questions[current];
          const newAnswers = [
            ...answers,
            { correct: knew, char: item.char, isReview: item.isReview },
          ];
          clearCanvas();
          const next = current + 1;
          if (next >= questions.length) {
            setQuizState((p) => ({ ...p, answers: newAnswers, done: true }));
            return;
          }
          setQuizState((p) => ({
            ...p,
            answers: newAnswers,
            current: next,
            options: buildOptions(questions[next], pool, type),
            revealed: false,
            selectedOption: null,
          }));
        };

        // ‚îÄ‚îÄ Canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const getPos = (e, canvas) => {
          const r = canvas.getBoundingClientRect();
          const s = e.touches ? e.touches[0] : e;
          return {
            x: (s.clientX - r.left) * (canvas.width / r.width),
            y: (s.clientY - r.top) * (canvas.height / r.height),
          };
        };
        const startDraw = (e) => {
          e.preventDefault();
          const c = canvasRef.current;
          if (!c) return;
          isDrawing.current = true;
          const p = getPos(e, c);
          lastPos.current = p;
          const ctx = c.getContext("2d");
          ctx.beginPath();
          ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
          ctx.fillStyle = "#2C1A0E";
          ctx.fill();
        };
        const draw = (e) => {
          e.preventDefault();
          if (!isDrawing.current) return;
          const c = canvasRef.current;
          if (!c) return;
          const ctx = c.getContext("2d");
          const p = getPos(e, c);
          ctx.beginPath();
          ctx.moveTo(lastPos.current.x, lastPos.current.y);
          ctx.lineTo(p.x, p.y);
          ctx.strokeStyle = "#2C1A0E";
          ctx.lineWidth = 5;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.stroke();
          lastPos.current = p;
        };
        const endDraw = (e) => {
          e.preventDefault();
          isDrawing.current = false;
          lastPos.current = null;
        };
        const clearCanvas = () => {
          const c = canvasRef.current;
          if (c) c.getContext("2d").clearRect(0, 0, c.width, c.height);
        };

        const handleCharHover = (e, item) => {
          if (!item.pinyin) return;
          const r = e.currentTarget.getBoundingClientRect();
          setTooltip({
            visible: true,
            char: item,
            x: r.left + r.width / 2,
            y: r.top + window.scrollY,
          });
        };

        // ‚îÄ‚îÄ TTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const SENT_ENDS = /[„ÄÇÔºÅÔºü‚Ä¶]/;
        const BAD_VOICE = /cantonese|yue|zh[-_]hk/i;
        const GOOD_VOICE = /mandarin|putonghua|ÊôÆÈÄöËØù|ÂõΩËØ≠/i;

        // Load & filter available Chinese voices
        const loadVoices = useCallback(() => {
          const all = window.speechSynthesis.getVoices();
          const zh = all.filter(
            (v) =>
              v.lang.startsWith("zh") &&
              !BAD_VOICE.test(v.name) &&
              !BAD_VOICE.test(v.lang),
          );
          if (zh.length === 0) return;
          setAvailableVoices(zh);
          // Auto-select best default if none chosen yet
          setTts((t) => {
            if (t.voiceURI) return t;
            const best =
              zh.find((v) => GOOD_VOICE.test(v.name)) ||
              zh.find((v) => v.lang === "zh-CN") ||
              zh[0];
            return { ...t, voiceURI: best.voiceURI };
          });
        }, []);

        useEffect(() => {
          loadVoices();
          window.speechSynthesis.onvoiceschanged = loadVoices;
          return () => {
            window.speechSynthesis.onvoiceschanged = null;
          };
        }, [loadVoices]);

        // Hard stop ‚Äî increment token so any in-flight speakNext calls self-abort
        const ttsStop = useCallback(() => {
          ttsToken.current += 1;
          window.speechSynthesis.cancel();
          // Chrome sometimes needs a nudge
          setTimeout(() => window.speechSynthesis.cancel(), 50);
          setTts((t) => ({ ...t, playing: false, sentenceIdx: -1 }));
        }, []);

        // Build sentences from parsedArticle
        const buildSentences = (article) => {
          const sentences = [];
          let cur = { text: "", startIdx: 0, endIdx: 0 };
          let si = 0;
          article.forEach((item, i) => {
            if (!item.char || item.type === "break") return;
            if (item.type === "punct") {
              cur.text += item.char;
              if (SENT_ENDS.test(item.char) && cur.text.trim()) {
                sentences.push({ ...cur, si: si++ });
                cur = { text: "", startIdx: i + 1, endIdx: i + 1 };
              }
            } else if (!item.type) {
              cur.text += item.char;
              cur.endIdx = i;
            }
          });
          if (cur.text.trim()) sentences.push({ ...cur, si: si });
          return sentences;
        };

        const ttsSpeak = useCallback(() => {
          if (!parsedArticle) return;

          // Stop any current playback first
          ttsToken.current += 1;
          const myToken = ttsToken.current;
          window.speechSynthesis.cancel();

          const sentences = buildSentences(parsedArticle);
          if (!sentences.length) return;

          const voices = window.speechSynthesis.getVoices();
          const chosenVoice =
            voices.find((v) => v.voiceURI === tts.voiceURI) || null;

          let pos = 0;
          setTts((t) => ({ ...t, playing: true, sentenceIdx: 0 }));

          const speakNext = () => {
            // Abort if a newer play session has started or stop was pressed
            if (ttsToken.current !== myToken) return;
            if (pos >= sentences.length) {
              setTts((t) => ({ ...t, playing: false, sentenceIdx: -1 }));
              return;
            }
            const sentence = sentences[pos];
            setTts((t) => ({ ...t, sentenceIdx: sentence.si }));

            const utt = new SpeechSynthesisUtterance(sentence.text);
            utt.lang = "zh-CN";
            utt.rate = tts.rate;
            if (chosenVoice) utt.voice = chosenVoice;

            utt.onend = () => {
              if (ttsToken.current !== myToken) return; // stale ‚Äî abort
              pos++;
              speakNext();
            };
            utt.onerror = (e) => {
              if (e.error === "interrupted" || e.error === "canceled") return; // expected on stop
              if (ttsToken.current !== myToken) return;
              pos++;
              speakNext();
            };
            window.speechSynthesis.speak(utt);
          };

          speakNext();
        }, [parsedArticle, tts.rate, tts.voiceURI]);

        useEffect(() => {
          return () => {
            ttsToken.current += 1;
            window.speechSynthesis.cancel();
          };
        }, [parsedArticle]);

        // Cache sentences so seek can use them without rebuilding
        const sentencesCache = useRef([]);
        useEffect(() => {
          if (parsedArticle)
            sentencesCache.current = buildSentences(parsedArticle);
        }, [parsedArticle]);

        const ttsSeek = useCallback(
          (e) => {
            if (!parsedArticle) return;
            const bar = e.currentTarget;
            const rect = bar.getBoundingClientRect();
            const clickX =
              (e.clientX || e.touches?.[0]?.clientX || rect.left) - rect.left;
            const pct = Math.max(0, Math.min(1, clickX / rect.width));
            const sentences = sentencesCache.current;
            if (!sentences.length) return;
            const targetPos = Math.floor(pct * sentences.length);

            // Stop current, then wait for Chrome to fully process cancel before starting
            ttsToken.current += 1;
            const myToken = ttsToken.current;
            window.speechSynthesis.cancel();

            const voices = window.speechSynthesis.getVoices();
            const chosenVoice =
              voices.find((v) => v.voiceURI === tts.voiceURI) || null;
            let pos = targetPos;
            setTts((t) => ({
              ...t,
              playing: true,
              sentenceIdx: sentences[targetPos]?.si ?? 0,
            }));

            const speakNext = () => {
              if (ttsToken.current !== myToken) return;
              if (pos >= sentences.length) {
                setTts((t) => ({ ...t, playing: false, sentenceIdx: -1 }));
                return;
              }
              const sentence = sentences[pos];
              setTts((t) => ({ ...t, sentenceIdx: sentence.si }));
              const utt = new SpeechSynthesisUtterance(sentence.text);
              utt.lang = "zh-CN";
              utt.rate = tts.rate;
              if (chosenVoice) utt.voice = chosenVoice;
              utt.onend = () => {
                if (ttsToken.current !== myToken) return;
                pos++;
                speakNext();
              };
              utt.onerror = (e) => {
                if (e.error === "interrupted" || e.error === "canceled") return;
                if (ttsToken.current !== myToken) return;
                pos++;
                speakNext();
              };
              window.speechSynthesis.speak(utt);
            };
            // Chrome needs ~150ms after cancel() before new speech works reliably
            setTimeout(speakNext, 150);
          },
          [parsedArticle, tts.rate, tts.voiceURI],
        );

        // Build sentenceIdx lookup: articleIndex ‚Üí si
        const sentenceMap = useRef({});
        useEffect(() => {
          if (!parsedArticle) return;
          const map = {};
          let si = 0;
          parsedArticle.forEach((item, i) => {
            if (!item.type && item.char) map[i] = si;
            if (item.type === "punct" && SENT_ENDS.test(item.char)) si++;
          });
          sentenceMap.current = map;
        }, [parsedArticle]);

        // ‚îÄ‚îÄ Screens ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const loadArticle = (entry) => {
          setParsedArticle(entry.arr);
          setImageDataUrl(entry.thumb);
          setScreen("reading");
        };

        const deleteHistory = (id, e) => {
          e.stopPropagation();
          setArticleHistory((prev) => prev.filter((h) => h.id !== id));
        };

        const renderHome = () => (
          <div>
            <div className="welcome-banner">
              <span style={{ fontSize: "3rem" }}>üéã</span>
              <div>
                <div
                  style={{
                    fontFamily: "'Fredoka One',cursive",
                    fontSize: "1.5rem",
                    marginBottom: 4,
                  }}
                >
                  Hello, Little Scholar! ‰Ω†Â•Ω!
                </div>
                <div style={{ opacity: 0.9, fontSize: "0.95rem" }}>
                  Upload a photo of your Chinese article to start reading &
                  learning!
                </div>
              </div>
              <div
                style={{ marginLeft: "auto", fontSize: "1.5rem", opacity: 0.7 }}
              >
                üèÆüèÆ
              </div>
            </div>

            <div
              className="upload-area"
              onDrop={onDrop}
              onDragOver={(e) => e.preventDefault()}
              onClick={() => fileRef.current?.click()}
            >
              <span className="upload-icon">üì∏</span>
              <div className="upload-title">
                Take a Photo or Upload an Image
              </div>
              <div className="upload-sub">
                Drop your Chinese article here, or click to choose a file
              </div>
              <input
                ref={fileRef}
                type="file"
                accept="image/*"
                capture="environment"
                style={{ display: "none" }}
                onChange={(e) => handleFile(e.target.files[0])}
              />
            </div>

            {unknownCount > 0 && (
              <div style={{ marginTop: 20, textAlign: "center" }}>
                <p
                  style={{
                    color: "var(--ink-light)",
                    marginBottom: 12,
                    fontFamily: "'Fredoka One',cursive",
                  }}
                >
                  You have {unknownCount} character{unknownCount > 1 ? "s" : ""}{" "}
                  in your study list üìö
                </p>
                <button
                  className="btn btn-jade"
                  onClick={() => setScreen("chars")}
                >
                  üìã Review My Characters
                </button>
              </div>
            )}

            {articleHistory.length > 0 && (
              <div style={{ marginTop: 28 }}>
                <div
                  style={{
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "space-between",
                    marginBottom: 14,
                  }}
                >
                  <div className="section-title">
                    üïê Recent Articles ({articleHistory.length}/10)
                  </div>
                  <button
                    className="btn btn-outline btn-sm"
                    style={{
                      fontSize: "0.75rem",
                      color: "#aaa",
                      borderColor: "#ddd",
                    }}
                    onClick={() => {
                      if (window.confirm("Clear all article history?"))
                        setArticleHistory([]);
                    }}
                  >
                    Clear All
                  </button>
                </div>
                <div
                  style={{ display: "flex", flexDirection: "column", gap: 10 }}
                >
                  {articleHistory.map((entry) => (
                    <div
                      key={entry.id}
                      onClick={() => loadArticle(entry)}
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: 14,
                        background: "white",
                        borderRadius: 16,
                        padding: "12px 14px",
                        boxShadow: "0 2px 10px rgba(0,0,0,0.07)",
                        cursor: "pointer",
                        border: "2px solid transparent",
                        transition: "all 0.2s",
                        position: "relative",
                      }}
                      onMouseEnter={(e) =>
                        (e.currentTarget.style.borderColor = "var(--gold)")
                      }
                      onMouseLeave={(e) =>
                        (e.currentTarget.style.borderColor = "transparent")
                      }
                    >
                      {entry.thumb ? (
                        <img
                          src={entry.thumb}
                          style={{
                            width: 56,
                            height: 56,
                            borderRadius: 10,
                            objectFit: "cover",
                            flexShrink: 0,
                            border: "2px solid #f0e8e0",
                          }}
                          alt=""
                        />
                      ) : (
                        <div
                          style={{
                            width: 56,
                            height: 56,
                            borderRadius: 10,
                            background: "var(--bg)",
                            display: "flex",
                            alignItems: "center",
                            justifyContent: "center",
                            fontSize: "1.8rem",
                            flexShrink: 0,
                          }}
                        >
                          üìÑ
                        </div>
                      )}
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div
                          style={{
                            fontFamily: "'Ma Shan Zheng',cursive",
                            fontSize: "1.1rem",
                            color: "var(--ink)",
                            whiteSpace: "nowrap",
                            overflow: "hidden",
                            textOverflow: "ellipsis",
                            marginBottom: 3,
                          }}
                        >
                          {entry.preview}
                        </div>
                        <div style={{ fontSize: "0.75rem", color: "#aaa" }}>
                          {entry.date}
                        </div>
                      </div>
                      <button
                        onClick={(e) => deleteHistory(entry.id, e)}
                        style={{
                          background: "none",
                          border: "none",
                          color: "#ccc",
                          cursor: "pointer",
                          fontSize: "1.1rem",
                          padding: "4px 6px",
                          flexShrink: 0,
                          lineHeight: 1,
                        }}
                        title="Remove"
                      >
                        √ó
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );

        const renderLoading = () => (
          <div className="loading-card">
            <div className="loading-chars">
              {["Â≠¶", "‰π†", "‰∏≠", "Êñá"].map((c, i) => (
                <span
                  key={i}
                  className="loading-char"
                  style={{
                    animationDelay: `${i * 0.15}s`,
                    color: [
                      "var(--red)",
                      "var(--gold)",
                      "var(--jade)",
                      "var(--sky)",
                    ][i],
                  }}
                >
                  {c}
                </span>
              ))}
            </div>
            <div
              style={{
                fontFamily: "'Fredoka One',cursive",
                fontSize: "1.2rem",
                color: "var(--ink-light)",
              }}
            >
              {loadingMsg}
            </div>
          </div>
        );

        const renderReading = () => {
          if (!parsedArticle) return null;
          return (
            <div>
              {imageDataUrl && (
                <img
                  src={imageDataUrl}
                  style={{
                    width: "100%",
                    maxHeight: 200,
                    objectFit: "cover",
                    borderRadius: 16,
                    marginBottom: 20,
                    border: "3px solid var(--gold)",
                  }}
                  alt="Article"
                />
              )}
              <div
                style={{
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "space-between",
                  marginBottom: 16,
                  flexWrap: "wrap",
                  gap: 10,
                }}
              >
                <div
                  style={{
                    fontFamily: "'Fredoka One',cursive",
                    fontSize: "1.3rem",
                    color: "var(--ink)",
                  }}
                >
                  üìñ Reading Mode
                </div>
                <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                  <button
                    className="btn btn-outline btn-sm"
                    onClick={() => {
                      setImageDataUrl(null);
                      setParsedArticle(null);
                      setScreen("home");
                    }}
                  >
                    üì∏ New Article
                  </button>
                  {unknownCount > 0 && (
                    <button
                      className="btn btn-jade btn-sm"
                      onClick={() => setScreen("chars")}
                    >
                      üìã Study List ({unknownCount})
                    </button>
                  )}
                </div>
              </div>
              <div className="reading-hint">
                üëÜ <strong>Tap any character</strong> you don't know to add it
                to your study list. Hover to peek at the meaning!
              </div>
              <div className="article-text">
                {parsedArticle.map((item, idx) => {
                  if (item.type === "break")
                    return (
                      <div key={idx} style={{ width: "100%", height: 8 }} />
                    );
                  if (item.type === "punct")
                    return (
                      <span key={idx} className="char-block punct">
                        <span className="char-pinyin" />
                        <span
                          className="char-zh"
                          style={{ fontSize: "1.4rem" }}
                        >
                          {item.char}
                        </span>
                      </span>
                    );
                  if (item.char === " ")
                    return <span key={idx} style={{ minWidth: 8 }} />;
                  const isUnknown = !!unknownChars[item.char];
                  const isSpeaking =
                    tts.playing && sentenceMap.current[idx] === tts.sentenceIdx;
                  return (
                    <span
                      key={idx}
                      className={`char-block ${isUnknown ? "unknown" : ""} ${isSpeaking ? "speaking" : ""}`}
                      onClick={() => toggleUnknown(item)}
                      onMouseEnter={(e) => handleCharHover(e, item)}
                      onMouseLeave={() =>
                        setTooltip((t) => ({ ...t, visible: false }))
                      }
                    >
                      <span className="char-pinyin">{item.pinyin || ""}</span>
                      <span className="char-zh">{item.char}</span>
                      {isUnknown && <span className="unknown-dot" />}
                    </span>
                  );
                })}
              </div>
              {/* TTS Player Bar */}
              {parsedArticle && (
                <div className="tts-bar">
                  <button
                    className="tts-btn"
                    title={tts.playing ? "Stop" : "Read Aloud"}
                    onClick={() => (tts.playing ? ttsStop() : ttsSpeak())}
                  >
                    {tts.playing ? "‚èπ" : "‚ñ∂Ô∏è"}
                  </button>
                  <div className="tts-progress">
                    {(() => {
                      const totalSentences = Math.max(
                        1,
                        sentencesCache.current.length ||
                          Object.keys(
                            parsedArticle.reduce((acc, item, i) => {
                              if (!item.type && item.char)
                                acc[sentenceMap.current[i] || 0] = 1;
                              return acc;
                            }, {}),
                          ).length,
                      );
                      const pct =
                        tts.sentenceIdx >= 0
                          ? Math.round(
                              ((tts.sentenceIdx + 1) / totalSentences) * 100,
                            )
                          : 0;
                      return (
                        <>
                          <div
                            className="tts-progress-bar"
                            onClick={ttsSeek}
                            onTouchStart={ttsSeek}
                            title="Click to jump to this position"
                          >
                            <div
                              className="tts-progress-fill"
                              style={{ width: `${pct}%` }}
                            />
                          </div>
                          <div
                            className="tts-label"
                            style={{
                              display: "flex",
                              justifyContent: "space-between",
                            }}
                          >
                            <span>
                              {tts.playing
                                ? "üîä Reading‚Ä¶"
                                : "‚ñ∂ Tap to hear the article read aloud"}
                            </span>
                            {tts.sentenceIdx >= 0 && (
                              <span
                                style={{ color: "var(--red)", fontWeight: 600 }}
                              >
                                {pct}%
                              </span>
                            )}
                          </div>
                        </>
                      );
                    })()}
                  </div>
                  <div
                    className="tts-speed"
                    style={{
                      display: "flex",
                      alignItems: "center",
                      gap: 6,
                      flexWrap: "wrap",
                    }}
                  >
                    {availableVoices.length > 1 && (
                      <select
                        value={tts.voiceURI}
                        onChange={(e) => {
                          ttsStop();
                          setTts((t) => ({ ...t, voiceURI: e.target.value }));
                        }}
                        style={{
                          border: "2px solid #e8ddd5",
                          borderRadius: 8,
                          padding: "4px 8px",
                          fontFamily: "'Fredoka One',cursive",
                          fontSize: "0.78rem",
                          background: "white",
                          cursor: "pointer",
                          maxWidth: 140,
                        }}
                        title="Choose voice"
                      >
                        {availableVoices.map((v) => (
                          <option key={v.voiceURI} value={v.voiceURI}>
                            {v.name
                              .replace(/Microsoft |Google |Apple /g, "")
                              .slice(0, 22)}
                          </option>
                        ))}
                      </select>
                    )}
                    <select
                      value={tts.rate}
                      onChange={(e) => {
                        ttsStop();
                        setTts((t) => ({
                          ...t,
                          rate: parseFloat(e.target.value),
                        }));
                      }}
                    >
                      <option value={0.5}>üê¢ Slow</option>
                      <option value={0.8}>üö∂ Normal</option>
                      <option value={1.0}>üèÉ Fast</option>
                    </select>
                  </div>
                </div>
              )}
              {unknownCount > 0 && (
                <div style={{ marginTop: 24, textAlign: "center" }}>
                  <button
                    className="btn btn-red"
                    onClick={() => setScreen("quiz")}
                  >
                    üéÆ Quiz Me on My {unknownCount} Characters!
                  </button>
                </div>
              )}
            </div>
          );
        };

        const renderChars = () => {
          const chars = Object.values(unknownChars);
          const mastered = Object.keys(masteredChars);
          return (
            <div>
              <div
                style={{
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "space-between",
                  marginBottom: 16,
                  flexWrap: "wrap",
                  gap: 8,
                }}
              >
                <div className="section-title">üìö My Study List</div>
                {chars.length > 0 && (
                  <button
                    className="btn btn-red btn-sm"
                    onClick={() => setScreen("quiz")}
                  >
                    üéÆ Start Quiz
                  </button>
                )}
              </div>
              {chars.length === 0 ? (
                <div className="empty-state">
                  <span
                    style={{
                      fontSize: "4rem",
                      display: "block",
                      marginBottom: 16,
                    }}
                  >
                    üì≠
                  </span>
                  <h3
                    style={{
                      fontFamily: "'Fredoka One',cursive",
                      fontSize: "1.4rem",
                      color: "var(--ink)",
                      marginBottom: 8,
                    }}
                  >
                    No characters yet!
                  </h3>
                  <p>Read an article and tap characters you don't know.</p>
                  <button
                    className="btn btn-gold"
                    style={{ marginTop: 20 }}
                    onClick={() => setScreen("home")}
                  >
                    üì∏ Upload an Article
                  </button>
                </div>
              ) : (
                <>
                  <p
                    style={{
                      color: "var(--ink-light)",
                      marginBottom: 16,
                      fontSize: "0.9rem",
                    }}
                  >
                    Tap a card to mark as mastered ‚≠ê ‚Ä¢ {mastered.length}{" "}
                    mastered so far!
                  </p>
                  <div className="char-grid">
                    {chars.map((item) => (
                      <div
                        key={item.char}
                        className="char-card"
                        onClick={() => markMastered(item.char)}
                      >
                        <button
                          style={{
                            position: "absolute",
                            top: 6,
                            right: 8,
                            background: "none",
                            border: "none",
                            color: "#ccc",
                            cursor: "pointer",
                            fontSize: "1rem",
                          }}
                          onClick={(e) => {
                            e.stopPropagation();
                            removeChar(item.char);
                          }}
                        >
                          √ó
                        </button>
                        <div className="big-char">{item.char}</div>
                        <div
                          style={{
                            fontSize: "0.85rem",
                            color: "var(--ink-light)",
                            marginBottom: 4,
                          }}
                        >
                          {item.pinyin}
                        </div>
                        <div style={{ fontSize: "0.78rem", color: "#888" }}>
                          {item.meaning}
                        </div>
                      </div>
                    ))}
                  </div>
                </>
              )}
              {mastered.length > 0 && (
                <div style={{ marginTop: 28 }}>
                  <div
                    style={{
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "space-between",
                      marginBottom: 8,
                    }}
                  >
                    <div className="section-title">
                      ‚≠ê Mastered ({mastered.length})
                    </div>
                  </div>
                  <p
                    style={{
                      color: "var(--ink-light)",
                      marginBottom: 12,
                      fontSize: "0.85rem",
                    }}
                  >
                    These appear occasionally in quizzes to keep them fresh üîÑ
                    Tap to move back to study list.
                  </p>
                  <div className="char-grid">
                    {mastered.map((k) => {
                      const info = masteredCharData[k] || {};
                      return (
                        <div
                          key={k}
                          className="char-card"
                          style={{
                            borderColor: "var(--jade)",
                            background: "rgba(46,204,154,0.05)",
                            cursor: "pointer",
                            position: "relative",
                          }}
                          onClick={() => {
                            setMasteredChars((prev) => {
                              const n = { ...prev };
                              delete n[k];
                              return n;
                            });
                            setUnknownChars((prev) => ({
                              ...prev,
                              [k]: {
                                char: k,
                                pinyin: info.pinyin || "?",
                                meaning: info.meaning || "",
                              },
                            }));
                            showToast(`‚Ü© "${k}" moved back to study list`);
                          }}
                        >
                          <div
                            style={{
                              position: "absolute",
                              top: 6,
                              right: 6,
                              fontSize: "0.65rem",
                              color: "var(--jade-dark)",
                              fontFamily: "'Fredoka One',cursive",
                            }}
                          >
                            ‚≠ê MASTERED
                          </div>
                          <div
                            className="big-char"
                            style={{ color: "var(--jade-dark)" }}
                          >
                            {k}
                          </div>
                          <div
                            style={{
                              fontSize: "0.85rem",
                              color: "var(--jade-dark)",
                              marginBottom: 4,
                            }}
                          >
                            {info.pinyin || ""}
                          </div>
                          <div style={{ fontSize: "0.78rem", color: "#888" }}>
                            {info.meaning || ""}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          );
        };

        const renderQuizTypeSelect = () => {
          const cardBase = {
            borderRadius: 20,
            padding: "24px 20px 22px",
            cursor: "pointer",
            border: "none",
            textAlign: "left",
            transition: "transform 0.2s, box-shadow 0.2s",
            position: "relative",
            overflow: "hidden",
            display: "block",
            width: "100%",
          };
          const badge = {
            display: "inline-block",
            background: "rgba(255,255,255,0.25)",
            borderRadius: 8,
            padding: "3px 10px",
            fontSize: "0.68rem",
            color: "white",
            fontFamily: "'Fredoka One',cursive",
            marginBottom: 12,
            letterSpacing: "0.05em",
          };
          const titleS = {
            fontFamily: "'Fredoka One',cursive",
            fontSize: "1.2rem",
            color: "white",
            marginBottom: 6,
          };
          const descS = {
            fontSize: "0.78rem",
            color: "rgba(255,255,255,0.82)",
            lineHeight: 1.45,
          };
          const cards = [
            {
              type: "pinyin",
              bg: "linear-gradient(135deg,#C0392B,#922B21)",
              badge: "MULTIPLE CHOICE",
              icon: "üî§",
              name: "Pinyin Quiz",
              text: "See the character, pick the right pronunciation",
            },
            {
              type: "meaning",
              bg: "linear-gradient(135deg,#1A7A5E,#0E6655)",
              badge: "MULTIPLE CHOICE",
              icon: "üí¨",
              name: "Meaning Quiz",
              text: "See the character, find the right English meaning",
            },
            {
              type: "flashcard",
              bg: "linear-gradient(135deg,#B7770D,#9A6209)",
              badge: "SELF GRADED",
              icon: "üÉè",
              name: "Flashcards",
              text: "Flip cards and test yourself honestly",
            },
            {
              type: "writing",
              bg: "linear-gradient(135deg,#1A5276,#154360)",
              badge: "SELF GRADED",
              icon: "‚úçÔ∏è",
              name: "Writing Quiz",
              text: "See the hint, draw the character by hand",
            },
          ];
          return (
            <div style={{ maxWidth: 560, margin: "0 auto", padding: "8px 0" }}>
              <div style={{ textAlign: "center", marginBottom: 32 }}>
                <span
                  style={{
                    fontSize: "3.5rem",
                    display: "block",
                    marginBottom: 10,
                  }}
                >
                  üèÆ
                </span>
                <div
                  style={{
                    fontFamily: "'Ma Shan Zheng',cursive",
                    fontSize: "2rem",
                    color: "var(--red)",
                    marginBottom: 4,
                  }}
                >
                  ÈÄâÊã©ÁªÉ‰π†ÊñπÂºè
                </div>
                <div style={{ color: "var(--ink-light)", fontSize: "0.95rem" }}>
                  Choose how you want to practice today
                </div>
              </div>
              <div
                style={{
                  display: "grid",
                  gridTemplateColumns: "1fr 1fr",
                  gap: 14,
                  marginBottom: 24,
                }}
              >
                {cards.map((c) => (
                  <button
                    key={c.type}
                    style={{ ...cardBase, background: c.bg }}
                    onClick={() => startQuiz(c.type)}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.transform = "translateY(-4px)";
                      e.currentTarget.style.boxShadow =
                        "0 12px 28px rgba(0,0,0,0.2)";
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.transform = "";
                      e.currentTarget.style.boxShadow = "";
                    }}
                  >
                    <span style={{ display: "inline-block", ...badge }}>
                      {c.badge}
                    </span>
                    <span
                      style={{
                        fontSize: "2.8rem",
                        display: "block",
                        marginBottom: 10,
                      }}
                    >
                      {c.icon}
                    </span>
                    <div style={titleS}>{c.name}</div>
                    <div style={descS}>{c.text}</div>
                  </button>
                ))}
              </div>
              <div style={{ textAlign: "center" }}>
                <button
                  className="btn btn-outline btn-sm"
                  onClick={() => setScreen("chars")}
                >
                  ‚Üê Back to Study List
                </button>
              </div>
            </div>
          );
        };

        const renderWritingQuiz = () => {
          const { questions, current, revealed, answers } = quizState;
          const item = questions[current];
          const sz = Math.min(window.innerWidth - 80, 280);
          return (
            <div style={{ maxWidth: 520, margin: "0 auto" }}>
              <div
                style={{
                  display: "flex",
                  gap: 6,
                  marginBottom: 24,
                  flexWrap: "wrap",
                }}
              >
                {questions.map((_, i) => (
                  <div
                    key={i}
                    className={`progress-dot ${i < answers.length ? (answers[i].correct ? "correct" : "wrong") : ""} ${i === current ? "current" : ""}`}
                  />
                ))}
              </div>
              <div
                style={{
                  textAlign: "center",
                  marginBottom: 12,
                  color: "var(--ink-light)",
                  fontSize: "0.85rem",
                  fontFamily: "'Fredoka One',cursive",
                }}
              >
                {current + 1} / {questions.length}
              </div>
              <div
                style={{
                  background: "white",
                  borderRadius: 28,
                  padding: "28px 32px",
                  textAlign: "center",
                  boxShadow: "0 8px 32px rgba(0,0,0,0.1)",
                  marginBottom: 16,
                  position: "relative",
                  overflow: "hidden",
                }}
              >
                <div
                  style={{
                    position: "absolute",
                    top: 0,
                    left: 0,
                    right: 0,
                    height: 6,
                    background:
                      "linear-gradient(90deg,var(--sky),var(--jade),var(--gold))",
                  }}
                />
                {item.isReview && (
                  <div
                    style={{
                      position: "absolute",
                      top: 14,
                      right: 16,
                      background: "rgba(46,204,154,0.15)",
                      border: "1px solid var(--jade)",
                      borderRadius: 8,
                      padding: "3px 10px",
                      fontSize: "0.7rem",
                      color: "var(--jade-dark)",
                      fontFamily: "'Fredoka One',cursive",
                    }}
                  >
                    ‚≠ê REVIEW
                  </div>
                )}
                <div
                  style={{
                    fontSize: "2rem",
                    color: "var(--red)",
                    fontWeight: 700,
                    marginBottom: 6,
                  }}
                >
                  {item.pinyin}
                </div>
                <div style={{ color: "var(--ink-light)" }}>{item.meaning}</div>
                <div
                  style={{ fontSize: "0.8rem", color: "#bbb", marginTop: 6 }}
                >
                  ‚úçÔ∏è Write the character below
                </div>
              </div>
              <div style={{ textAlign: "center" }}>
                <div
                  style={{
                    position: "relative",
                    display: "inline-block",
                    marginBottom: 16,
                  }}
                >
                  <canvas
                    ref={canvasRef}
                    width={sz}
                    height={sz}
                    className="writing-canvas"
                    style={{ width: sz, height: sz }}
                    onMouseDown={startDraw}
                    onMouseMove={draw}
                    onMouseUp={endDraw}
                    onMouseLeave={endDraw}
                    onTouchStart={startDraw}
                    onTouchMove={draw}
                    onTouchEnd={endDraw}
                  />
                  <svg
                    style={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      pointerEvents: "none",
                      borderRadius: 14,
                    }}
                    width={sz}
                    height={sz}
                  >
                    <line
                      x1={sz / 2}
                      y1="8"
                      x2={sz / 2}
                      y2={sz - 8}
                      stroke="#f0e8e0"
                      strokeWidth="1.5"
                      strokeDasharray="6,4"
                    />
                    <line
                      x1="8"
                      y1={sz / 2}
                      x2={sz - 8}
                      y2={sz / 2}
                      stroke="#f0e8e0"
                      strokeWidth="1.5"
                      strokeDasharray="6,4"
                    />
                    <line
                      x1="8"
                      y1="8"
                      x2={sz - 8}
                      y2={sz - 8}
                      stroke="#f0e8e0"
                      strokeWidth="1"
                      strokeDasharray="4,6"
                    />
                    <line
                      x1={sz - 8}
                      y1="8"
                      x2="8"
                      y2={sz - 8}
                      stroke="#f0e8e0"
                      strokeWidth="1"
                      strokeDasharray="4,6"
                    />
                  </svg>
                </div>
              </div>
              <div
                style={{
                  display: "flex",
                  gap: 10,
                  justifyContent: "center",
                  marginBottom: 16,
                  flexWrap: "wrap",
                }}
              >
                <button
                  className="btn btn-outline btn-sm"
                  onClick={clearCanvas}
                >
                  üóëÔ∏è Clear
                </button>
                {!revealed && (
                  <button
                    className="btn btn-gold"
                    onClick={() =>
                      setQuizState((p) => ({ ...p, revealed: true }))
                    }
                  >
                    üëÄ Reveal Answer
                  </button>
                )}
              </div>
              {revealed && (
                <>
                  <div
                    style={{
                      background: "rgba(192,57,43,0.06)",
                      border: "2px solid var(--red)",
                      borderRadius: 20,
                      padding: "16px 24px",
                      textAlign: "center",
                      marginBottom: 16,
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      gap: 20,
                    }}
                  >
                    <div
                      style={{
                        fontFamily: "'Ma Shan Zheng',cursive",
                        fontSize: "5rem",
                        color: "var(--red)",
                        lineHeight: 1,
                      }}
                    >
                      {item.char}
                    </div>
                    <div style={{ textAlign: "left" }}>
                      <div
                        style={{
                          fontSize: "1.1rem",
                          color: "var(--ink)",
                          fontWeight: 500,
                        }}
                      >
                        {item.pinyin}
                      </div>
                      <div
                        style={{
                          fontSize: "0.9rem",
                          color: "var(--ink-light)",
                          marginTop: 4,
                        }}
                      >
                        {item.meaning}
                      </div>
                    </div>
                  </div>
                  <div
                    style={{
                      display: "flex",
                      gap: 10,
                      justifyContent: "center",
                      marginBottom: 12,
                    }}
                  >
                    <button
                      className="btn btn-red"
                      onClick={() => handleFlashcard(false)}
                    >
                      üòÖ Not quite
                    </button>
                    <button
                      className="btn btn-jade"
                      onClick={() => handleFlashcard(true)}
                    >
                      üåü Got it!
                    </button>
                  </div>
                </>
              )}
              <div style={{ textAlign: "center" }}>
                <button
                  className="btn btn-outline btn-sm"
                  onClick={() => {
                    clearCanvas();
                    setQuizState(null);
                  }}
                >
                  ‚Ü© Change Mode
                </button>
              </div>
            </div>
          );
        };

        const renderQuiz = () => {
          if (!quizState) return renderQuizTypeSelect();
          if (quizState.done) return renderQuizResult();
          const {
            questions,
            current,
            type,
            options,
            revealed,
            selectedOption,
            answers,
          } = quizState;
          const item = questions[current];
          if (type === "writing") return renderWritingQuiz();
          const isFlash = type === "flashcard";
          return (
            <div style={{ maxWidth: 520, margin: "0 auto" }}>
              <div
                style={{
                  display: "flex",
                  gap: 6,
                  marginBottom: 24,
                  flexWrap: "wrap",
                }}
              >
                {questions.map((_, i) => (
                  <div
                    key={i}
                    className={`progress-dot ${i < answers.length ? (answers[i].correct ? "correct" : "wrong") : ""} ${i === current ? "current" : ""}`}
                  />
                ))}
              </div>
              <div
                style={{
                  textAlign: "center",
                  marginBottom: 8,
                  color: "var(--ink-light)",
                  fontSize: "0.85rem",
                  fontFamily: "'Fredoka One',cursive",
                }}
              >
                {current + 1} / {questions.length}
              </div>
              <div className="quiz-card" style={{ position: "relative" }}>
                {item.isReview && (
                  <div
                    style={{
                      position: "absolute",
                      top: 14,
                      right: 16,
                      background: "rgba(46,204,154,0.15)",
                      border: "1px solid var(--jade)",
                      borderRadius: 8,
                      padding: "3px 10px",
                      fontSize: "0.7rem",
                      color: "var(--jade-dark)",
                      fontFamily: "'Fredoka One',cursive",
                    }}
                  >
                    ‚≠ê REVIEW
                  </div>
                )}
                <div
                  style={{
                    fontSize: "0.82rem",
                    color: "#aaa",
                    textTransform: "uppercase",
                    letterSpacing: "0.1em",
                    marginBottom: 16,
                  }}
                >
                  {isFlash
                    ? "What's the pinyin & meaning?"
                    : type === "pinyin"
                      ? "Pick the correct pinyin"
                      : "Pick the correct meaning"}
                </div>
                <div className="quiz-char">{item.char}</div>
                {isFlash && (
                  <div
                    style={{
                      fontSize: "1.1rem",
                      color: revealed ? "var(--red)" : "transparent",
                      marginTop: 8,
                      minHeight: 28,
                      fontWeight: 500,
                    }}
                  >
                    {revealed ? (
                      <div>
                        <div>{item.pinyin}</div>
                        <div
                          style={{
                            fontSize: "0.9rem",
                            color: "#888",
                            marginTop: 4,
                          }}
                        >
                          {item.meaning}
                        </div>
                      </div>
                    ) : (
                      "‚Ä¢‚Ä¢‚Ä¢"
                    )}
                  </div>
                )}
              </div>
              {isFlash ? (
                revealed ? (
                  <div
                    style={{
                      display: "flex",
                      gap: 10,
                      justifyContent: "center",
                    }}
                  >
                    <button
                      className="btn btn-red"
                      onClick={() => handleFlashcard(false)}
                    >
                      üòÖ Didn't Know
                    </button>
                    <button
                      className="btn btn-jade"
                      onClick={() => handleFlashcard(true)}
                    >
                      üåü I Knew It!
                    </button>
                  </div>
                ) : (
                  <div style={{ textAlign: "center" }}>
                    <button
                      className="btn btn-gold"
                      onClick={() =>
                        setQuizState((p) => ({ ...p, revealed: true }))
                      }
                    >
                      üëÄ Reveal Answer
                    </button>
                  </div>
                )
              ) : (
                <div className="quiz-options">
                  {options.map((opt, i) => {
                    const isThisCorrect =
                      type === "pinyin"
                        ? opt.pinyin === item.pinyin
                        : opt.meaning === item.meaning;
                    const isChosen = opt.char === quizState.chosenChar;
                    let cls = "";
                    if (selectedOption) {
                      if (isThisCorrect) cls = "correct";
                      else if (isChosen) cls = "wrong";
                    }
                    return (
                      <button
                        key={i}
                        className={`option-btn ${cls}`}
                        onClick={() => !selectedOption && handleAnswer(opt)}
                        disabled={!!selectedOption}
                      >
                        {type === "pinyin" ? (
                          <span style={{ fontSize: "1.1rem", fontWeight: 500 }}>
                            {opt.pinyin}
                          </span>
                        ) : (
                          <span style={{ fontSize: "0.95rem" }}>
                            {opt.meaning}
                          </span>
                        )}
                      </button>
                    );
                  })}
                </div>
              )}
              <div style={{ textAlign: "center", marginTop: 12 }}>
                <button
                  className="btn btn-outline btn-sm"
                  onClick={() => setQuizState(null)}
                >
                  ‚Ü© Change Mode
                </button>
              </div>
            </div>
          );
        };

        const renderQuizResult = () => {
          const { answers } = quizState;
          const correct = answers.filter((a) => a.correct).length;
          const pct = Math.round((correct / answers.length) * 100);
          const emoji =
            pct >= 90 ? "üèÜ" : pct >= 70 ? "üåü" : pct >= 50 ? "üòä" : "üí™";
          const msg =
            pct >= 90
              ? "Outstanding!"
              : pct >= 70
                ? "Great job!"
                : pct >= 50
                  ? "Good effort!"
                  : "Keep practicing!";
          return (
            <div
              style={{
                maxWidth: 520,
                margin: "0 auto",
                textAlign: "center",
                padding: "40px 20px",
              }}
            >
              <span
                style={{ fontSize: "5rem", display: "block", marginBottom: 16 }}
              >
                {emoji}
              </span>
              <div
                style={{
                  fontFamily: "'Fredoka One',cursive",
                  fontSize: "2rem",
                  color: "var(--ink)",
                  marginBottom: 8,
                }}
              >
                {msg}
              </div>
              <div
                style={{
                  fontSize: "1.1rem",
                  color: "var(--ink-light)",
                  marginBottom: 24,
                }}
              >
                {pct}% ‚Äî {correct} out of {answers.length} correct
              </div>
              <div
                style={{
                  display: "flex",
                  gap: 16,
                  justifyContent: "center",
                  marginBottom: 28,
                  flexWrap: "wrap",
                }}
              >
                {[
                  { n: correct, l: "Correct", c: "var(--jade)" },
                  {
                    n: answers.length - correct,
                    l: "To Review",
                    c: "var(--red)",
                  },
                  {
                    n: Object.keys(masteredChars).length,
                    l: "Mastered",
                    c: "var(--gold)",
                  },
                ].map((s) => (
                  <div
                    key={s.l}
                    style={{
                      background: "white",
                      borderRadius: 16,
                      padding: "16px 24px",
                      textAlign: "center",
                      boxShadow: "0 3px 12px rgba(0,0,0,0.08)",
                      minWidth: 90,
                    }}
                  >
                    <div
                      style={{
                        fontFamily: "'Fredoka One',cursive",
                        fontSize: "2rem",
                        color: s.c,
                      }}
                    >
                      {s.n}
                    </div>
                    <div style={{ fontSize: "0.8rem", color: "#888" }}>
                      {s.l}
                    </div>
                  </div>
                ))}
              </div>
              <div
                style={{
                  display: "flex",
                  gap: 10,
                  justifyContent: "center",
                  flexWrap: "wrap",
                }}
              >
                <button
                  className="btn btn-red"
                  onClick={() => startQuiz(quizState.type)}
                >
                  üîÅ Try Again
                </button>
                <button
                  className="btn btn-gold"
                  onClick={() => setQuizState(null)}
                >
                  üéÆ Change Mode
                </button>
                <button
                  className="btn btn-outline"
                  onClick={() => {
                    setQuizState(null);
                    setScreen("chars");
                  }}
                >
                  üìã Study List
                </button>
              </div>
            </div>
          );
        };

        return (
          <div className="app">
            <div className="header">
              <div className="logo">
                üèÆ{" "}
                <span style={{ fontFamily: "'Ma Shan Zheng',cursive" }}>
                  Â∞èÂ≠¶ËÄÖ
                </span>{" "}
                Little Scholar
              </div>
              <div className="nav-tabs">
                <button
                  className={`nav-tab ${screen === "home" ? "active" : ""}`}
                  onClick={() => setScreen("home")}
                >
                  üè† Home
                </button>
                {parsedArticle && (
                  <button
                    className={`nav-tab ${screen === "reading" ? "active" : ""}`}
                    onClick={() => setScreen("reading")}
                  >
                    üìñ Read
                  </button>
                )}
                <button
                  className={`nav-tab ${screen === "chars" ? "active" : ""}`}
                  onClick={() => setScreen("chars")}
                >
                  üìö Study{" "}
                  {unknownCount > 0 && (
                    <span className="count-badge">{unknownCount}</span>
                  )}
                </button>
                <button
                  className={`nav-tab ${screen === "quiz" ? "active" : ""}`}
                  onClick={() => {
                    if (unknownCount > 0) setScreen("quiz");
                    else showToast("Add characters to your study list first!");
                  }}
                >
                  üéÆ Quiz
                </button>
                <button
                  className="nav-tab"
                  style={{ borderColor: "#ccc", color: "#aaa" }}
                  onClick={async () => {
                    await apiLogout();
                    onLogout();
                  }}
                >
                  üö™
                </button>
              </div>
            </div>
            {loading ? (
              renderLoading()
            ) : (
              <>
                {screen === "home" && renderHome()}
                {screen === "reading" && renderReading()}
                {screen === "chars" && renderChars()}
                {screen === "quiz" && renderQuiz()}
              </>
            )}
            {tooltip.visible && tooltip.char && (
              <div
                className="char-tooltip"
                style={{ left: tooltip.x, top: tooltip.y }}
              >
                <div
                  style={{
                    color: "var(--gold-light)",
                    fontSize: "0.95rem",
                    fontWeight: 500,
                    marginBottom: 3,
                  }}
                >
                  {tooltip.char.pinyin}
                </div>
                <div style={{ color: "#ddd", fontSize: "0.8rem" }}>
                  {tooltip.char.meaning}
                </div>
              </div>
            )}
            <div className={`toast ${toast.show ? "show" : ""}`}>
              {toast.msg}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<Root />);
    </script>
  </body>
</html>
